<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WFRP Character Sheet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #d4c5a0;
            min-height: 100vh;
            padding: 20px;
        }

        .character-sheet {
            max-width: 1200px;
            margin: 0 auto;
            background: #faf8f3;
            border: 3px solid #3e2f1f;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Header */
        .sheet-header {
            background: #3e2f1f;
            color: #faf8f3;
            padding: 15px 20px;
            border-bottom: 2px solid #2a1f14;
        }

        .header-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .header-field {
            display: flex;
            flex-direction: column;
        }

        .header-field label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            color: #c4b5a0;
        }

        .header-field input {
            background: rgba(250, 248, 243, 0.9);
            border: 1px solid #2a1f14;
            color: #2a1f14;
            padding: 6px 8px;
            font-family: 'Georgia', serif;
            font-size: 14px;
        }

        .character-name input {
            font-size: 18px;
            font-weight: bold;
        }

        /* Main Content */
        .sheet-content {
            padding: 20px;
        }

        /* Characteristics Table */
        .characteristics-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #3e2f1f;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px solid #3e2f1f;
            padding-bottom: 5px;
        }

        .characteristics-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #3e2f1f;
        }

        .characteristics-table th {
            background: #3e2f1f;
            color: #faf8f3;
            padding: 8px 6px;
            text-align: center;
            font-size: 11px;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid #2a1f14;
        }

        .characteristics-table td {
            border: 1px solid #8b7355;
            padding: 4px;
            text-align: center;
            position: relative;
        }

        .characteristics-table tr:nth-child(even) {
            background: #f5f0e8;
        }

        .char-name-cell {
            font-weight: bold;
            text-align: left !important;
            padding-left: 10px !important;
            font-size: 12px;
            color: #3e2f1f;
            background: #e8dfd0;
        }

        .characteristics-table input {
            width: 100%;
            border: none;
            text-align: center;
            padding: 6px 2px;
            font-size: 14px;
            font-weight: bold;
            background: transparent;
        }

        .characteristics-table input:focus {
            outline: 2px solid #8b7355;
            background: #fffef5;
        }

        .current-cell {
            background: #e8dfd0;
            font-weight: bold;
        }

        .current-cell input {
            font-size: 16px;
            color: #3e2f1f;
        }

        /* Skills Section */
        .skills-section {
            margin-bottom: 25px;
        }

        .skills-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .skills-filter {
            padding: 5px 10px;
            border: 1px solid #8b7355;
            font-family: 'Georgia', serif;
            background: white;
        }

        .skills-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #3e2f1f;
            font-size: 12px;
        }

        .skills-table th {
            background: #3e2f1f;
            color: #faf8f3;
            padding: 6px 4px;
            text-align: center;
            font-size: 10px;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid #2a1f14;
        }

        .skills-table td {
            border: 1px solid #8b7355;
            padding: 3px;
            text-align: center;
        }

        .skills-table tr:nth-child(even) {
            background: #f5f0e8;
        }

        .skill-name-cell {
            text-align: left !important;
            padding-left: 8px !important;
            font-weight: bold;
            color: #3e2f1f;
        }

        .skills-table input[type="number"] {
            width: 40px;
            border: none;
            text-align: center;
            padding: 2px;
            font-size: 12px;
            background: transparent;
        }

        .skills-table input[type="checkbox"] {
            transform: scale(1.2);
        }

        .advance-btn {
            width: 20px;
            height: 20px;
            border: 1px solid #8b7355;
            background: #f5f0e8;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .advance-btn:hover {
            background: #e8dfd0;
        }

        .skill-total {
            font-weight: bold;
            color: #3e2f1f;
            background: #e8dfd0 !important;
        }

        /* Secondary Characteristics Table */
        .secondary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .secondary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #3e2f1f;
        }

        .secondary-table th {
            background: #3e2f1f;
            color: #faf8f3;
            padding: 6px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid #2a1f14;
        }

        .secondary-table td {
            border: 1px solid #8b7355;
            padding: 6px;
        }

        .secondary-table input {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 14px;
            background: transparent;
            text-align: center;
        }

        .secondary-table input:focus {
            outline: 2px solid #8b7355;
            background: #fffef5;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 12px 24px;
            background: #3e2f1f;
            color: #faf8f3;
            border: 2px solid #2a1f14;
            font-family: 'Georgia', serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .control-btn:hover {
            background: #2a1f14;
            transform: translateY(-2px);
        }

        /* Experience & Status Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .info-box {
            border: 2px solid #3e2f1f;
            background: white;
            padding: 10px;
        }

        .info-box-title {
            font-size: 11px;
            font-weight: bold;
            color: #3e2f1f;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-align: center;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 3px;
        }

        .info-box input {
            width: 100%;
            border: 1px solid #8b7355;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-grid {
                grid-template-columns: 1fr;
            }
            
            .secondary-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .characteristics-table {
                font-size: 12px;
            }
            
            .characteristics-table input {
                font-size: 12px;
            }

            .skills-table {
                font-size: 10px;
            }

            .skills-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="character-sheet">
        <!-- Header Section -->
        <div class="sheet-header">
            <div class="header-grid">
                <div class="header-field character-name">
                    <label>Character Name</label>
                    <input type="text" id="character-name" placeholder="Enter name...">
                </div>
                <div class="header-field">
                    <label>Species</label>
                    <input type="text" id="species" placeholder="Human">
                </div>
                <div class="header-field">
                    <label>Class</label>
                    <input type="text" id="class" placeholder="Ranger">
                </div>
                <div class="header-field">
                    <label>Career</label>
                    <input type="text" id="career" placeholder="Hunter">
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="sheet-content">
            <!-- Primary Characteristics Table -->
            <div class="characteristics-section">
                <div class="section-title">Characteristics</div>
                <table class="characteristics-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Characteristic</th>
                            <th style="width: 15%;">Initial</th>
                            <th style="width: 15%;">Advances</th>
                            <th style="width: 15%;" class="current-cell">Current</th>
                            <th style="width: 25%;">Advance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="char-name-cell">Weapon Skill (WS)</td>
                            <td><input type="number" id="ws-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="ws-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="ws-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('ws')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="ws-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Ballistic Skill (BS)</td>
                            <td><input type="number" id="bs-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="bs-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="bs-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('bs')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="bs-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Strength (S)</td>
                            <td><input type="number" id="s-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="s-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="s-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('s')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="s-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Toughness (T)</td>
                            <td><input type="number" id="t-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="t-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="t-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('t')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="t-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Initiative (I)</td>
                            <td><input type="number" id="i-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="i-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="i-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('i')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="i-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Agility (Ag)</td>
                            <td><input type="number" id="ag-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="ag-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="ag-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('ag')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="ag-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Dexterity (Dex)</td>
                            <td><input type="number" id="dex-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="dex-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="dex-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('dex')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="dex-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Intelligence (Int)</td>
                            <td><input type="number" id="int-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="int-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="int-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('int')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="int-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Willpower (WP)</td>
                            <td><input type="number" id="wp-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="wp-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="wp-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('wp')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="wp-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="char-name-cell">Fellowship (Fel)</td>
                            <td><input type="number" id="fel-initial" placeholder="20" min="0" max="100"></td>
                            <td><input type="number" id="fel-advances" placeholder="0" min="0"></td>
                            <td class="current-cell"><input type="number" id="fel-current" placeholder="20" readonly></td>
                            <td style="text-align: center;">
                                <button onclick="window.advanceCharacteristic('fel')" style="padding: 5px 10px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                                <span id="fel-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(25 XP)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Skills Section -->
            <div class="characteristics-section skills-section">
                <div class="section-title">Skills</div>
                <div class="skills-controls">
                    <select class="skills-filter" id="skills-filter">
                        <option value="all">All Skills</option>
                        <option value="career">Career Skills</option>
                        <option value="basic">Basic Skills</option>
                        <option value="advanced">Advanced Skills</option>
                    </select>
                    <button class="control-btn" onclick="window.addSkill()" style="padding: 5px 10px; font-size: 12px;">+ Add Skill</button>
                </div>
                
                <!-- Unified Skills Table -->
                <table class="skills-table" id="skills-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Skill</th>
                            <th style="width: 8%;">Char</th>
                            <th style="width: 8%;">Type</th>
                            <th style="width: 8%;">Career</th>
                            <th style="width: 8%;">Adv</th>
                            <th style="width: 8%;">Total</th>
                            <th style="width: 20%;">Advance</th>
                            <th style="width: 13%;">Notes</th>
                            <th style="width: 2%;">Del</th>
                        </tr>
                    </thead>
                    <tbody id="skills-tbody">
                    </tbody>
                </table>

                <!-- Add Skill Modal -->
                <div id="add-skill-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; min-width: 400px;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Skill</h3>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Skill:</label>
                            <select id="skill-select" style="width: 100%; padding: 5px;" onchange="window.toggleSpecialisationField()">
                                <option value="">Select a skill...</option>
                            </select>
                        </div>
                        <div id="specialisation-field" style="margin-bottom: 15px; display: none;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Specialisation:</label>
                            <input type="text" id="specialisation-input" placeholder="e.g. Fighting, Battle, Bow..." style="width: 100%; padding: 5px;">
                        </div>
                        <div style="text-align: center;">
                            <button class="control-btn" onclick="window.confirmAddSkill()" style="margin-right: 10px; padding: 8px 16px;">Add Skill</button>
                            <button class="control-btn" onclick="window.closeAddSkillModal()" style="padding: 8px 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
<!-- Talents Section -->
            <div class="characteristics-section">
                <div class="section-title">Talents</div>
                <div class="talents-controls" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <button class="control-btn" onclick="window.addTalent()" style="padding: 5px 10px; font-size: 12px;">+ Add Talent</button>
                    <input type="text" id="talents-search" placeholder="Search talents..." style="padding: 5px 10px; border: 1px solid #8b7355; font-family: 'Georgia', serif; background: white;">
                </div>
                
                <table class="skills-table" id="talents-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Talent</th>
                            <th style="width: 12%;">Times Taken</th>
                            <th style="width: 15%;">Advance</th>
                            <th style="width: 50%;">Description</th>
                            <th style="width: 3%;">Del</th>
                        </tr>
                    </thead>
                    <tbody id="talents-tbody">
                    </tbody>
                </table>

                <!-- Add Talent Modal -->
                <div id="add-talent-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; min-width: 500px; max-width: 600px; max-height: 70vh; overflow-y: auto;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Talent</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Search Talents:</label>
                            <input type="text" id="talent-search-modal" placeholder="Type to search..." style="width: 100%; padding: 5px;" oninput="window.filterTalentOptions()">
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Select Talent:</label>
                            <select id="talent-select" size="8" style="width: 100%; padding: 5px;" onchange="window.showTalentDetails()">
                            </select>
                        </div>
                        
                        <div id="talent-details" style="display: none; margin-bottom: 15px; padding: 10px; background: #e8dfd0; border: 1px solid #8b7355;">
                            <h4 style="color: #3e2f1f; margin-bottom: 10px;">Talent Details</h4>
                            <p><strong>Name:</strong> <span id="detail-talent-name"></span></p>
                            <p><strong>Max:</strong> <span id="detail-talent-max"></span></p>
                            <p><strong>Tests:</strong> <span id="detail-talent-tests"></span></p>
                            <p style="margin-top: 10px;"><strong>Description:</strong></p>
                            <p id="detail-talent-description" style="font-style: italic; line-height: 1.4;"></p>
                        </div>
                        
                        <div id="talent-customisation" style="display: none; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Specialisation/Details:</label>
                            <input type="text" id="talent-customisation-input" placeholder="e.g., specific skill, weapon group, etc." style="width: 100%; padding: 5px;">
                        </div>
                        
                        <div id="talent-times-taken" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Times Taken:</label>
                            <input type="number" id="talent-times-input" value="1" min="1" max="10" style="width: 100px; padding: 5px;">
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: #f0e6d2; border: 1px solid #8b7355; border-radius: 3px;">
                            <label style="display: flex; align-items: center; color: #3e2f1f; font-size: 14px; cursor: pointer;">
                                <input type="checkbox" id="talent-xp-override" style="margin-right: 8px;">
                                <strong>Add for Free</strong> <span style="margin-left: 8px; font-size: 12px; color: #666;">(mutation, story reward, etc.)</span>
                            </label>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="control-btn" onclick="window.confirmAddTalent()" style="margin-right: 10px; padding: 8px 16px;">Add Talent</button>
                            <button class="control-btn" onclick="window.closeAddTalentModal()" style="padding: 8px 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conditions & Status Effects -->
            <div class="section">
                <div class="section-title">Conditions & Status Effects</div>
                
                <!-- Penalty Summary -->
                <div id="condition-penalties-summary" style="background: #fff8dc; border: 2px solid #d4a574; padding: 10px; margin-bottom: 15px; border-radius: 5px; display: none;">
                    <h4 style="color: #8b4513; margin: 0 0 8px 0; font-size: 14px;">📊 Active Penalties</h4>
                    <div id="penalty-text" style="color: #8b4513; font-size: 13px; font-weight: bold;"></div>
                </div>
                
                <!-- Conditions Controls -->
                <div class="conditions-controls" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                    <button class="control-btn" onclick="window.openAddConditionModal()" style="padding: 5px 10px; font-size: 12px;">+ Add Condition</button>
                    <button class="control-btn" onclick="window.removeAllConditions()" style="padding: 5px 10px; font-size: 12px; background: #c41e3a; color: white;">Clear All</button>
                    <input type="text" id="conditions-search" placeholder="Search active conditions..." style="padding: 5px 10px; border: 1px solid #8b7355; font-family: 'Georgia', serif; background: white; flex: 1; min-width: 200px;">
                </div>
                
                <!-- Active Conditions Display -->
                <div id="active-conditions-display" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <!-- Conditions will be dynamically populated here -->
                </div>
                
                <!-- No Conditions Message -->
                <div id="no-conditions-message" style="text-align: center; padding: 20px; color: #666; font-style: italic; display: none;">
                    No conditions currently affecting this character.
                </div>

                <!-- Add Condition Modal -->
                <div id="add-condition-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; min-width: 500px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add WFRP Condition</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Select Condition:</label>
                            <select id="condition-select" style="width: 100%; padding: 8px; font-size: 14px;" onchange="window.showConditionDetails()">
                                <option value="">-- Choose a condition --</option>
                            </select>
                        </div>
                        
                        <div id="condition-details" style="display: none; margin-bottom: 15px; padding: 15px; background: #e8dfd0; border: 2px solid #8b7355; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #3e2f1f; margin: 0;" id="detail-condition-name"></h4>
                                <span id="condition-severity-badge" style="padding: 3px 8px; font-size: 11px; color: white; border-radius: 3px; font-weight: bold;"></span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #3e2f1f;">Stackable:</strong> 
                                <span id="detail-condition-stackable" style="font-weight: bold;"></span>
                            </div>
                            <div>
                                <strong style="color: #3e2f1f;">Effects:</strong>
                                <p id="detail-condition-effects" style="font-style: italic; line-height: 1.4; margin: 5px 0; color: #333;"></p>
                            </div>
                        </div>
                        
                        <div id="stacks-input-section" style="margin-bottom: 15px; display: none;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Number of Stacks to Add:</label>
                            <input type="number" id="condition-stacks-input" value="1" min="1" max="10" style="width: 80px; padding: 5px; text-align: center;">
                            <span style="margin-left: 10px; color: #666; font-size: 13px;">This condition can stack - add multiple at once if needed</span>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="control-btn" onclick="window.confirmAddCondition()" style="margin-right: 10px; padding: 8px 16px;">Add Condition</button>
                            <button class="control-btn" onclick="window.closeAddConditionModal()" style="padding: 8px 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Critical Wounds & Injuries -->
            <div class="section">
                <div class="section-title">Critical Wounds & Injuries</div>
                
                <!-- Wound Penalties Summary -->
                <div id="wound-penalties-summary" style="background: #ffe4e6; border: 2px solid #c41e3a; padding: 10px; margin-bottom: 15px; border-radius: 5px; display: none;">
                    <h4 style="color: #8b0000; margin: 0 0 8px 0; font-size: 14px;">🩸 Active Wound Penalties</h4>
                    <div id="wound-penalty-text" style="color: #8b0000; font-size: 13px; font-weight: bold;"></div>
                </div>
                
                <!-- Wounds Controls -->
                <div class="wounds-controls" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                    <button class="control-btn" onclick="window.openAddWoundModal()" style="padding: 5px 10px; font-size: 12px;">+ Add Critical Wound</button>
                    <button class="control-btn" onclick="window.openWoundReferenceModal()" style="padding: 5px 10px; font-size: 12px; background: #4682b4; color: white;">📖 WFRP Reference</button>
                    <button class="control-btn" onclick="window.removeAllWounds()" style="padding: 5px 10px; font-size: 12px; background: #c41e3a; color: white;">Clear All</button>
                    <input type="text" id="wounds-search" placeholder="Search active wounds..." style="padding: 5px 10px; border: 1px solid #8b7355; font-family: 'Georgia', serif; background: white; flex: 1; min-width: 200px;">
                </div>
                
                <!-- Active Wounds Display -->
                <div id="active-wounds-display" style="margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse; background: #faf8f3; border: 2px solid #8b7355;">
                        <thead>
                            <tr style="background: #e8dfd0; color: #3e2f1f; font-weight: bold;">
                                <th style="border: 1px solid #8b7355; padding: 8px; text-align: left;">Name</th>
                                <th style="border: 1px solid #8b7355; padding: 8px; text-align: center;">Location</th>
                                <th style="border: 1px solid #8b7355; padding: 8px; text-align: center;">Healing Progress</th>
                                <th style="border: 1px solid #8b7355; padding: 8px; text-align: left;">Effects</th>
                                <th style="border: 1px solid #8b7355; padding: 8px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="wounds-tbody">
                            <!-- Wounds will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- No Wounds Message -->
                <div id="no-wounds-message" style="text-align: center; padding: 20px; color: #666; font-style: italic; display: none;">
                    No critical wounds currently affecting this character.
                </div>

                <!-- Add Critical Wound Modal -->
                <div id="add-wound-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; min-width: 600px; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Critical Wound</h3>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Wound Name:</label>
                                <input type="text" id="wound-name-input" style="width: 100%; padding: 8px; font-family: Georgia, serif;" placeholder="Enter wound name...">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Location:</label>
                                <select id="wound-location-select" style="width: 100%; padding: 8px; font-family: Georgia, serif;">
                                    <option value="">-- Select Location --</option>
                                    <option value="Head">Head</option>
                                    <option value="Right Arm">Right Arm</option>
                                    <option value="Left Arm">Left Arm</option>
                                    <option value="Body">Body</option>
                                    <option value="Right Leg">Right Leg</option>
                                    <option value="Left Leg">Left Leg</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Wounds Value:</label>
                                <input type="number" id="wound-wounds-input" style="width: 100%; padding: 8px; font-family: Georgia, serif;" min="0" placeholder="Wounds dealt...">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Healing Time (Days):</label>
                                <input type="number" id="wound-healing-time-input" style="width: 100%; padding: 8px; font-family: Georgia, serif;" min="0" placeholder="Days to heal...">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Effects Description:</label>
                            <textarea id="wound-effects-input" style="width: 100%; padding: 8px; font-family: Georgia, serif; height: 80px; resize: vertical;" placeholder="Describe the wound effects, penalties, and conditions..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f; font-weight: bold;">Notes:</label>
                            <textarea id="wound-notes-input" style="width: 100%; padding: 8px; font-family: Georgia, serif; height: 60px; resize: vertical;" placeholder="Additional notes, medical attention required, etc..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <input type="checkbox" id="wound-permanent-checkbox" style="margin-right: 5px;">
                                <label for="wound-permanent-checkbox" style="color: #3e2f1f; font-weight: bold;">Permanent Injury</label>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">This wound never fully heals</div>
                            </div>
                            <div>
                                <input type="checkbox" id="wound-surgery-checkbox" style="margin-right: 5px;">
                                <label for="wound-surgery-checkbox" style="color: #3e2f1f; font-weight: bold;">Surgery Required</label>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">Needs surgical intervention</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="control-btn" onclick="window.confirmAddWound()" style="margin-right: 10px; padding: 8px 16px;">Add Wound</button>
                            <button class="control-btn" onclick="window.closeAddWoundModal()" style="padding: 8px 16px;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- WFRP Reference Modal -->
                <div id="wound-reference-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; width: 90%; max-width: 900px; height: 80vh; overflow-y: auto;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">WFRP 4th Edition Critical Wounds Reference</h3>
                        
                        <!-- Location Tabs -->
                        <div style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #8b7355;">
                            <button onclick="window.showWoundLocation('Head')" id="wound-tab-Head" style="padding: 8px 16px; background: #e8dfd0; border: none; color: #3e2f1f; font-weight: bold; cursor: pointer; border-top: 2px solid #8b7355; border-left: 2px solid #8b7355; border-right: 2px solid #8b7355;">Head</button>
                            <button onclick="window.showWoundLocation('Arm')" id="wound-tab-Arm" style="padding: 8px 16px; background: #f5f5f0; border: none; color: #666; cursor: pointer; border-top: 2px solid #8b7355; border-left: 2px solid #8b7355; border-right: 2px solid #8b7355;">Arms</button>
                            <button onclick="window.showWoundLocation('Body')" id="wound-tab-Body" style="padding: 8px 16px; background: #f5f5f0; border: none; color: #666; cursor: pointer; border-top: 2px solid #8b7355; border-left: 2px solid #8b7355; border-right: 2px solid #8b7355;">Body</button>
                            <button onclick="window.showWoundLocation('Leg')" id="wound-tab-Leg" style="padding: 8px 16px; background: #f5f5f0; border: none; color: #666; cursor: pointer; border-top: 2px solid #8b7355; border-left: 2px solid #8b7355; border-right: 2px solid #8b7355;">Legs</button>
                        </div>
                        
                        <!-- Search Box -->
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="wound-reference-search" placeholder="Search wounds by name or effects..." style="width: 100%; padding: 8px; font-family: Georgia, serif; border: 2px solid #8b7355;">
                        </div>
                        
                        <!-- Wound Tables -->
                        <div id="wound-reference-content" style="max-height: 500px; overflow-y: auto;">
                            <!-- Content will be populated by showWoundLocation() -->
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="control-btn" onclick="window.closeWoundReferenceModal()" style="padding: 8px 16px;">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spells & Prayers -->
            <div class="section">
                <div class="section-title">Spells & Prayers</div>
                <div class="spells-controls" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="control-btn" onclick="window.addSpell()" style="padding: 5px 10px; font-size: 12px;">+ Add Spell/Prayer</button>
                    <input type="text" id="spells-search" placeholder="Search spells..." style="padding: 5px 10px; border: 1px solid #8b7355; font-family: 'Georgia', serif; background: white;">
                    <select id="spells-filter" style="padding: 5px; border: 1px solid #8b7355; font-family: 'Georgia', serif;">
                        <option value="all">All Types</option>
                        <option value="arcane">Arcane Spells</option>
                        <option value="divine">Divine Prayers</option>
                        <option value="memorised">Memorised Only</option>
                    </select>
                </div>
                
                <table class="skills-table" id="spells-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Name</th>
                            <th style="width: 8%;">CN</th>
                            <th style="width: 12%;">Range</th>
                            <th style="width: 12%;">Target</th>
                            <th style="width: 10%;">Duration</th>
                            <th style="width: 28%;">Effect</th>
                            <th style="width: 8%;">Mem</th>
                            <th style="width: 4%;">Del</th>
                        </tr>
                    </thead>
                    <tbody id="spells-tbody">
                    </tbody>
                </table>

                <!-- Add Spell Modal -->
                <div id="add-spell-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; min-width: 600px; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Spell or Prayer</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Source:</label>
                            <select id="spell-source-input" style="width: 100%; padding: 5px;" onchange="window.toggleSpellSource()">
                                <option value="custom">Custom Spell/Prayer</option>
                                <option value="srd">Select from SRD</option>
                            </select>
                        </div>
                        
                        <!-- SRD Spell Selection -->
                        <div id="srd-spell-section" style="display: none; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Search SRD Spells:</label>
                            <input type="text" id="srd-spell-search" placeholder="Type to search..." style="width: 100%; padding: 5px; margin-bottom: 10px;" oninput="window.filterSRDSpells()">
                            
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Select Spell:</label>
                            <select id="srd-spell-select" size="8" style="width: 100%; padding: 5px;" onchange="window.showSRDSpellDetails()">
                            </select>
                            
                            <div id="srd-spell-details" style="display: none; margin-top: 10px; padding: 10px; background: #e8dfd0; border: 1px solid #8b7355;">
                                <h4 style="color: #3e2f1f; margin-bottom: 10px;">Spell Details</h4>
                                <p><strong>Name:</strong> <span id="srd-detail-name"></span></p>
                                <p><strong>Lore:</strong> <span id="srd-detail-lore"></span></p>
                                <p><strong>CN:</strong> <span id="srd-detail-cn"></span></p>
                                <p><strong>Range:</strong> <span id="srd-detail-range"></span></p>
                                <p><strong>Target:</strong> <span id="srd-detail-target"></span></p>
                                <p><strong>Duration:</strong> <span id="srd-detail-duration"></span></p>
                            </div>
                        </div>
                        
                        <!-- Custom Spell Entry -->
                        <div id="custom-spell-section">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Name:</label>
                                <input type="text" id="spell-name-input" placeholder="Spell/Prayer name" style="width: 100%; padding: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Type:</label>
                                <select id="spell-type-input" style="width: 100%; padding: 5px;" onchange="window.updateLoreOptions()">
                                    <option value="arcane">Arcane Spell</option>
                                    <option value="divine">Divine Prayer</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Lore/Deity:</label>
                                <select id="spell-lore-input" style="width: 100%; padding: 5px;">
                                    <option value="">Select Lore...</option>
                                    <option value="Petty Magic">Petty Magic</option>
                                    <option value="Fire">Fire</option>
                                    <option value="Metal">Metal</option>
                                    <option value="Life">Life</option>
                                    <option value="Light">Light</option>
                                    <option value="Heavens">Heavens</option>
                                    <option value="Shadow">Shadow</option>
                                    <option value="Death">Death</option>
                                    <option value="Beasts">Beasts</option>
                                    <option value="Daemonology">Daemonology</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">CN (Casting Number):</label>
                                <input type="number" id="spell-cn-input" placeholder="5" min="0" max="30" style="width: 100%; padding: 5px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Range:</label>
                                <input type="text" id="spell-range-input" placeholder="e.g., Touch, 12 yards" style="width: 100%; padding: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Target:</label>
                                <input type="text" id="spell-target-input" placeholder="e.g., 1 creature" style="width: 100%; padding: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Duration:</label>
                                <input type="text" id="spell-duration-input" placeholder="e.g., Instant, 1 hour" style="width: 100%; padding: 5px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Effect:</label>
                            <textarea id="spell-effect-input" placeholder="Describe the spell's effect..." style="width: 100%; padding: 5px; height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Ingredients/Components:</label>
                                <input type="text" id="spell-ingredients-input" placeholder="Optional ingredients or components" style="width: 100%; padding: 5px;">
                            </div>
                        </div>
                        </div>
                        
                        <!-- Memorised checkbox (applies to both SRD and custom spells) -->
                        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <label style="color: #3e2f1f;">
                                <input type="checkbox" id="spell-memorised-input" style="margin-right: 5px;">
                                Currently Memorised/Prepared
                            </label>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="control-btn" onclick="window.confirmAddSpell()" style="margin-right: 10px; padding: 8px 16px;">Add Spell</button>
                            <button class="control-btn" onclick="window.closeAddSpellModal()" style="padding: 8px 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secondary Characteristics -->
            <div class="characteristics-section">
                <div class="section-title">Secondary Characteristics</div>
                <div class="secondary-grid">
                    <table class="secondary-table">
                        <tr>
                            <th>Wounds</th>
                            <td style="width: 40%;"><input type="number" id="wounds-current" placeholder="12"></td>
                            <td style="width: 10%; text-align: center;">/</td>
                            <td style="width: 40%;"><input type="number" id="wounds-max" placeholder="12"></td>
                        </tr>
                        <tr>
                            <th>Hardy</th>
                            <td colspan="3"><input type="number" id="hardy" placeholder="0"></td>
                        </tr>
                        <tr>
                            <th>Corruption</th>
                            <td style="width: 40%;"><input type="number" id="corruption-current" placeholder="0"></td>
                            <td style="width: 10%; text-align: center;">/</td>
                            <td style="width: 40%;"><input type="number" id="corruption-max" placeholder="10"></td>
                        </tr>
                    </table>

                    <table class="secondary-table">
                        <tr>
                            <th>Movement</th>
                            <td><input type="number" id="movement" placeholder="4"></td>
                        </tr>
                        <tr>
                            <th>Walk</th>
                            <td><input type="number" id="walk" placeholder="8" readonly></td>
                        </tr>
                        <tr>
                            <th>Run</th>
                            <td><input type="number" id="run" placeholder="16" readonly></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Fate, Fortune, Resilience & Resolve -->
            <div class="characteristics-section">
                <div class="section-title">Fate & Fortune / Resilience & Resolve</div>
                <div class="secondary-grid">
                    <div style="background: #f8f6f0; border: 2px solid #3e2f1f; padding: 15px; border-radius: 5px;">
                        <h4 style="color: #3e2f1f; margin-top: 0; margin-bottom: 10px; font-size: 14px;">Fate & Fortune</h4>
                        
                        <!-- Fate Points -->
                        <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
                            <label style="width: 60px; color: #3e2f1f; font-weight: bold; font-size: 13px;">Fate:</label>
                            <button onclick="window.updateFate(-1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">−</button>
                            <input type="number" id="fate" placeholder="0" style="width: 50px; text-align: center; border: 1px solid #8b7355;">
                            <button onclick="window.updateFate(1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">+</button>
                        </div>
                        
                        <!-- Fortune Points -->
                        <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
                            <label style="width: 60px; color: #3e2f1f; font-weight: bold; font-size: 13px;">Fortune:</label>
                            <button onclick="window.updateFortune(-1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">−</button>
                            <input type="number" id="fortune-current" placeholder="0" style="width: 40px; text-align: center; border: 1px solid #8b7355;">
                            <span style="color: #666; font-size: 13px;">/</span>
                            <span id="fortune-max" style="color: #666; font-size: 13px; width: 20px;">0</span>
                            <button onclick="window.updateFortune(1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">+</button>
                            <button onclick="window.restoreFortune()" style="padding: 3px 8px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer; margin-left: 5px;">Restore</button>
                        </div>
                    </div>
                    
                    <div style="background: #f0f6f8; border: 2px solid #3e2f1f; padding: 15px; border-radius: 5px;">
                        <h4 style="color: #3e2f1f; margin-top: 0; margin-bottom: 10px; font-size: 14px;">Resilience & Resolve</h4>
                        
                        <!-- Resilience Points -->
                        <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
                            <label style="width: 70px; color: #3e2f1f; font-weight: bold; font-size: 13px;">Resilience:</label>
                            <button onclick="window.updateResilience(-1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">−</button>
                            <input type="number" id="resilience" placeholder="0" style="width: 50px; text-align: center; border: 1px solid #8b7355;">
                            <button onclick="window.updateResilience(1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">+</button>
                        </div>
                        
                        <!-- Resolve Points -->
                        <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
                            <label style="width: 70px; color: #3e2f1f; font-weight: bold; font-size: 13px;">Resolve:</label>
                            <button onclick="window.updateResolve(-1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">−</button>
                            <input type="number" id="resolve-current" placeholder="0" style="width: 40px; text-align: center; border: 1px solid #8b7355;">
                            <span style="color: #666; font-size: 13px;">/</span>
                            <span id="resolve-max" style="color: #666; font-size: 13px; width: 20px;">0</span>
                            <button onclick="window.updateResolve(1)" style="width: 25px; height: 25px; cursor: pointer; background: #e8dfd0; border: 1px solid #8b7355;">+</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <table class="secondary-table" style="width: 100%;">
                        <tr>
                            <th style="width: 20%;">Motivation</th>
                            <td><input type="text" id="motivation" placeholder="What drives your character forward?" style="width: 100%; border: none;"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Experience & Status -->
            <div class="info-grid">
                <div class="info-box">
                    <div class="info-box-title">Experience Points</div>
                    <button onclick="window.openXPEarnDialog()" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer; font-size: 12px;">Add Session XP</button>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px;"><span>Total XP:</span><span id="xp-total-display">0</span></div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px;"><span>Current XP:</span><span id="xp-current-display">0</span></div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px;"><span>Spent XP:</span><span id="xp-spent-display">0</span></div>
                    <input type="hidden" id="xp-total" value="0">
                    <input type="hidden" id="xp-spent" value="0">
                </div>
                <div class="info-box">
                    <div class="info-box-title">Status</div>
                    <select id="status-tier" style="width: 100%; padding: 5px; text-align: center; font-size: 14px; margin-top: 5px; border: 1px solid #8b7355;">
                        <option value="Brass">Brass</option>
                        <option value="Silver">Silver</option>
                        <option value="Gold">Gold</option>
                    </select>
                    <input type="number" id="status-standing" placeholder="Standing">
                </div>
                <div class="info-box">
                    <div class="info-box-title">Sin Points</div>
                    <input type="number" id="sin-points" placeholder="0" min="0">
                </div>
                <div class="info-box">
                    <div class="info-box-title">Notes</div>
                    <textarea id="quick-notes" style="width: 100%; height: 60px; margin-top: 5px; border: 1px solid #8b7355; padding: 5px;" placeholder="Quick notes..."></textarea>
                </div>
            </div>

            <!-- Combat Section -->
            <div class="characteristics-section">
                <div class="section-title">Combat</div>
                
                <!-- Weapons Table -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Weapons</h4>
                        <button class="control-btn" onclick="window.addWeapon()" style="padding: 5px 10px; font-size: 12px;">+ Add Weapon</button>
                    </div>
                    <table class="skills-table" id="weapons-table">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Weapon</th>
                                <th style="width: 10%;">Group</th>
                                <th style="width: 8%;">Enc</th>
                                <th style="width: 10%;">Range</th>
                                <th style="width: 12%;">Damage</th>
                                <th style="width: 25%;">Qualities</th>
                                <th style="width: 8%;">Equipped</th>
                                <th style="width: 2%;">Del</th>
                            </tr>
                        </thead>
                        <tbody id="weapons-tbody">
                        </tbody>
                    </table>
                </div>

                <!-- Armour Table -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Armour</h4>
                        <button class="control-btn" onclick="window.addArmour()" style="padding: 5px 10px; font-size: 12px;">+ Add Armour</button>
                    </div>
                    <table class="skills-table" id="armour-table">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Armour</th>
                                <th style="width: 10%;">Type</th>
                                <th style="width: 8%;">Enc</th>
                                <th style="width: 8%;">Head</th>
                                <th style="width: 8%;">Arms</th>
                                <th style="width: 8%;">Body</th>
                                <th style="width: 8%;">Legs</th>
                                <th style="width: 15%;">Qualities</th>
                                <th style="width: 8%;">Worn</th>
                                <th style="width: 2%;">Del</th>
                            </tr>
                        </thead>
                        <tbody id="armour-tbody">
                        </tbody>
                    </table>
                </div>

                <!-- Armour Points Summary -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Total Armour Points</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Head</div>
                            <input type="number" id="total-ap-head" value="0" readonly style="text-align: center; font-weight: bold;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Arms</div>
                            <input type="number" id="total-ap-arms" value="0" readonly style="text-align: center; font-weight: bold;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Body</div>
                            <input type="number" id="total-ap-body" value="0" readonly style="text-align: center; font-weight: bold;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Legs</div>
                            <input type="number" id="total-ap-legs" value="0" readonly style="text-align: center; font-weight: bold;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment & Inventory Section -->
            <div class="characteristics-section">
                <div class="section-title">Equipment & Inventory</div>
                
                <!-- Money Tracker -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Wealth</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Gold Crowns</div>
                            <input type="number" id="money-gold" value="0" min="0" onchange="window.updateEncumbrance()" style="text-align: center;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Silver Shillings</div>
                            <input type="number" id="money-silver" value="0" min="0" onchange="window.updateEncumbrance()" style="text-align: center;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Brass Pennies</div>
                            <input type="number" id="money-brass" value="0" min="0" onchange="window.updateEncumbrance()" style="text-align: center;">
                        </div>
                    </div>
                </div>

                <!-- Encumbrance Tracker -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Encumbrance</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Current Enc</div>
                            <input type="number" id="current-enc" value="0" readonly style="text-align: center; font-weight: bold;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Max Enc (SB+TB)</div>
                            <input type="number" id="max-enc" value="0" readonly style="text-align: center;">
                        </div>
                        <div class="info-box" style="padding: 8px;">
                            <div class="info-box-title" style="font-size: 10px;">Status</div>
                            <input type="text" id="enc-status" value="Unencumbered" readonly style="text-align: center; font-size: 12px;">
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #8b7355; line-height: 1.4;">
                        <div id="enc-details" style="padding: 5px; background: #f5f0e8; border: 1px solid #d4c5a0;">
                            <strong>Encumbrance Breakdown:</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                                <div>• Weapons (equipped): <span id="enc-weapons">0</span></div>
                                <div>• Armour (worn -1 Enc): <span id="enc-armour">0</span></div>
                                <div>• Trappings: <span id="enc-trappings">0</span></div>
                                <div>• Money (200 coins = 1 Enc): <span id="enc-money">0</span></div>
                            </div>
                            <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #d4c5a0;">
                                <strong>Current Penalties:</strong> <span id="enc-penalties" style="color: green;">None</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trappings/Inventory -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Trappings & Equipment</h4>
                        <button class="control-btn" onclick="window.addTrapping()" style="padding: 5px 10px; font-size: 12px;">+ Add Item</button>
                    </div>
                    <table class="skills-table" id="trappings-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Item</th>
                                <th style="width: 10%;">Quantity</th>
                                <th style="width: 10%;">Enc (each)</th>
                                <th style="width: 10%;">Total Enc</th>
                                <th style="width: 15%;">Location</th>
                                <th style="width: 23%;">Notes</th>
                                <th style="width: 2%;">Del</th>
                            </tr>
                        </thead>
                        <tbody id="trappings-tbody">
                        </tbody>
                    </table>
                </div>

                <!-- Ammunition & Consumables -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #3e2f1f; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Ammunition & Consumables</h4>
                        <button class="control-btn" onclick="window.addConsumable()" style="padding: 5px 10px; font-size: 12px;">+ Add Consumable</button>
                    </div>
                    <table class="skills-table" id="consumables-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Item</th>
                                <th style="width: 15%;">Current</th>
                                <th style="width: 15%;">Maximum</th>
                                <th style="width: 38%;">Notes</th>
                                <th style="width: 2%;">Del</th>
                            </tr>
                        </thead>
                        <tbody id="consumables-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <button class="control-btn" onclick="saveCharacter()">💾 Save</button>
        <button class="control-btn" onclick="loadCharacter()">📂 Load</button>
    </div>

    <script>
        // Initialize character data
        let character = {
            name: '',
            species: '',
            class: '',
            career: '',
            careerLevel: '',
            careerPath: '',
            status: '',
            age: '',
            height: '',
            hair: '',
            eyes: '',
            attributes: {
                WS: { initial: 0, advances: 0, current: 0 },
                BS: { initial: 0, advances: 0, current: 0 },
                S: { initial: 0, advances: 0, current: 0 },
                T: { initial: 0, advances: 0, current: 0 },
                I: { initial: 0, advances: 0, current: 0 },
                Ag: { initial: 0, advances: 0, current: 0 },
                Dex: { initial: 0, advances: 0, current: 0 },
                Int: { initial: 0, advances: 0, current: 0 },
                WP: { initial: 0, advances: 0, current: 0 },
                Fel: { initial: 0, advances: 0, current: 0 }
            },
            fate: { fortune: 0, fate: 0 },
            resilience: { resolve: 0, resilience: 0 },
            experience: { current: 0, spent: 0, total: 0 },
            movement: 4,
            wounds: { current: 0, max: 0 },
            skills: [],
            talents: [],
            trappings: [],
            wealth: { brass: 0, silver: 0, gold: 0 },
            psychology: '',
            motivation: '',
            shortTermAmbitions: '',
            longTermAmbitions: '',
            corruption: { current: 0, max: 0 },
            mutations: []
        };

        // Expose character to window for debugging
        window.character = character;

        // Global variables
        let characterSkills = {};
        let addedSkills = []; // Track all manually added skills
        let weapons = [];
        let armour = [];
        let trappings = [];
        let consumables = [];
        
        // WFRP 4th Edition Official Conditions
        const wfrpConditions = {
          "Ablaze": {
            stackable: true,
            severity: "severe",
            effects: { damage: "1d10/round", damagePerStack: "+1" },
            description: "You are on fire! At the end of every Round, suffer 1d10 Wounds (+1 per extra Ablaze). Remove with Athletics Test."
          },
          "Bleeding": {
            stackable: true,
            severity: "severe",
            effects: { damage: "1/round", diseaseResistance: -10 },
            description: "Lose 1 Wound/round, -10 to resist infections. Remove with Heal Test or healing spells."
          },
          "Blinded": {
            stackable: true,
            severity: "minor",
            effects: { sightTests: -10, enemyMeleeBonus: 10 },
            description: "Cannot see properly. -10 to sight Tests, enemies +10 to hit in melee."
          },
          "Broken": {
            stackable: true,
            severity: "moderate",
            effects: { allTests: -10, mustFlee: true },
            description: "Terrified and panicked. Must flee/hide, -10 to all Tests except running/hiding."
          },
          "Deafened": {
            stackable: true,
            severity: "minor",
            effects: { hearingTests: -10, flankingBonus: 10 },
            description: "-10 to hearing Tests, enemies from flank/rear get extra +10 to hit."
          },
          "Entangled": {
            stackable: true,
            severity: "positional",
            effects: { noMovement: true, movementTests: -10 },
            description: "Cannot move, -10 to movement Tests. Remove with opposed Strength Test."
          },
          "Fatigued": {
            stackable: true,
            severity: "minor",
            effects: { allTests: -10 },
            description: "Exhausted. -10 penalty to ALL Tests."
          },
          "Poisoned": {
            stackable: true,
            severity: "moderate",
            effects: { damage: "1/round", allTests: -10 },
            description: "Lose 1 Wound/round, -10 to all Tests. Remove with Endurance or Heal Tests."
          },
          "Prone": {
            stackable: false,
            severity: "positional",
            effects: { movementTests: -20, enemyMeleeBonus: 20 },
            description: "On the ground. -20 to movement Tests, enemies +20 to hit in melee."
          },
          "Stunned": {
            stackable: true,
            severity: "moderate",
            effects: { noActions: true, allTests: -10, enemyAdvantage: 1 },
            description: "Cannot take Actions, -10 to all Tests, enemies gain +1 Advantage."
          },
          "Surprised": {
            stackable: false,
            severity: "positional",
            effects: { noActions: true, noMovement: true, enemyMeleeBonus: 20 },
            description: "Cannot act or move, enemies +20 to hit."
          },
          "Unconscious": {
            stackable: false,
            severity: "severe",
            effects: { incapacitated: true, autoKill: true },
            description: "Knocked out. Cannot act, attackers auto-hit with killing blows."
          }
        };

        // WFRP 4th Edition Official Critical Wounds Reference Data
        const wfrpCriticalWounds = {
          // HEAD WOUNDS
          "head_dramatic_injury": {
            name: "Dramatic Injury",
            wounds: "T",
            effects: "Gain 1 Bleeding Condition. +1 SL to social Tests once healed (once only)",
            conditions: ["Bleeding"],
            location: "Head",
            severity: "minor"
          },
          "head_earring": {
            name: "Earring",
            wounds: 1,
            effects: "Gain 1 Bleeding Condition. Ear pierced by weapon. +1 SL to appropriate social Tests once healed (once only)",
            conditions: ["Bleeding"],
            location: "Head",
            severity: "minor"
          },
          "head_black_eye": {
            name: "Black Eye",
            wounds: 1,
            effects: "Gain 1 Bleeding Condition. -10 penalty to all Sight Tests for 1d10 days",
            conditions: ["Bleeding"],
            location: "Head",
            severity: "minor"
          },
          "head_nose_bleed": {
            name: "Nose Bleed",
            wounds: 2,
            effects: "Gain 1 Bleeding Condition. No additional effects",
            conditions: ["Bleeding"],
            location: "Head",
            severity: "minor"
          },
          "head_fractured_jaw": {
            name: "Fractured Jaw",
            wounds: 2,
            effects: "Gain 2 Stunned Conditions. Broken Bone (Minor) injury",
            conditions: ["Stunned", "Stunned"],
            injuries: ["Broken Bone (Minor)"],
            location: "Head",
            severity: "moderate"
          },
          "head_broken_nose": {
            name: "Broken Nose",
            wounds: 2,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. Broken Bone (Minor) injury",
            conditions: ["Bleeding", "Stunned"],
            injuries: ["Broken Bone (Minor)"],
            location: "Head",
            severity: "moderate"
          },
          "head_broken_teeth": {
            name: "Broken Teeth",
            wounds: 3,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. -10 to Language Tests permanently",
            conditions: ["Bleeding", "Stunned"],
            permanentEffects: ["-10 Language Tests"],
            location: "Head",
            severity: "moderate"
          },
          "head_mangled_jaw": {
            name: "Mangled Jaw",
            wounds: 3,
            effects: "Gain 2 Bleeding, 1 Stunned Condition. -20 to Language Tests permanently",
            conditions: ["Bleeding", "Bleeding", "Stunned"],
            permanentEffects: ["-20 Language Tests"],
            location: "Head",
            severity: "severe"
          },
          "head_lost_eye": {
            name: "Lost Eye",
            wounds: 4,
            effects: "Gain 2 Bleeding, 1 Stunned Condition. -20 to all Ranged Tests permanently. Amputation (Average)",
            conditions: ["Bleeding", "Bleeding", "Stunned"],
            permanentEffects: ["-20 Ranged Tests"],
            amputation: "Eye",
            location: "Head",
            severity: "severe"
          },
          "head_mangled_ear": {
            name: "Mangled Ear",
            wounds: 4,
            effects: "Gain 2 Bleeding, 1 Stunned Condition. -20 to all Hearing Tests permanently. Amputation (Average)",
            conditions: ["Bleeding", "Bleeding", "Stunned"],
            permanentEffects: ["-20 Hearing Tests"],
            amputation: "Ear",
            location: "Head",
            severity: "severe"
          },
          "head_brain_damage": {
            name: "Brain Damage",
            wounds: 5,
            effects: "Gain 3 Bleeding, 2 Stunned, 1 Unconscious Condition. -10 to Int, WP, Fel permanently",
            conditions: ["Bleeding", "Bleeding", "Bleeding", "Stunned", "Stunned", "Unconscious"],
            permanentEffects: ["-10 Intelligence", "-10 Willpower", "-10 Fellowship"],
            location: "Head",
            severity: "fatal"
          },
          "head_shattered_skull": {
            name: "Shattered Skull",
            wounds: "Death",
            effects: "Head caved in, instantly dead",
            fatal: true,
            location: "Head",
            severity: "fatal"
          },

          // ARM WOUNDS  
          "arm_dramatic_injury": {
            name: "Dramatic Injury",
            wounds: "T",
            effects: "Gain 1 Bleeding Condition. +1 SL to social Tests once healed (once only)",
            conditions: ["Bleeding"],
            location: "Arm",
            severity: "minor"
          },
          "arm_bloody_mess": {
            name: "Bloody Mess",
            wounds: 1,
            effects: "Gain 1 Bleeding Condition. No additional effects",
            conditions: ["Bleeding"],
            location: "Arm",
            severity: "minor"
          },
          "arm_torn_muscles": {
            name: "Torn Muscles",
            wounds: 2,
            effects: "Gain 1 Bleeding Condition. Torn Muscle (Minor) injury",
            conditions: ["Bleeding"],
            injuries: ["Torn Muscle (Minor)"],
            location: "Arm",
            severity: "minor"
          },
          "arm_pinned_arm": {
            name: "Pinned Arm", 
            wounds: 2,
            effects: "Gain 1 Bleeding, 1 Entangled Condition. Arm trapped until opponent moved away",
            conditions: ["Bleeding", "Entangled"],
            location: "Arm",
            severity: "moderate"
          },
          "arm_broken_collar_bone": {
            name: "Broken Collar Bone",
            wounds: 3,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. Broken Bone (Minor) injury. -10 to tests using arm",
            conditions: ["Bleeding", "Stunned"],
            injuries: ["Broken Bone (Minor)"],
            location: "Arm",
            severity: "moderate"
          },
          "arm_broken_elbow": {
            name: "Broken Elbow",
            wounds: 3,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. Broken Bone (Major) injury. Arm unusable",
            conditions: ["Bleeding", "Stunned"],
            injuries: ["Broken Bone (Major)"],
            location: "Arm",
            severity: "severe"
          },
          "arm_broken_arm": {
            name: "Broken Arm",
            wounds: 4,
            effects: "Gain 1 Bleeding, 2 Stunned Conditions. Broken Bone (Major) injury. Arm unusable",
            conditions: ["Bleeding", "Stunned", "Stunned"],
            injuries: ["Broken Bone (Major)"],
            location: "Arm",
            severity: "severe"
          },
          "arm_dislocated_shoulder": {
            name: "Dislocated Shoulder",
            wounds: 4,
            effects: "Arm counts as lost until Medical Attention. Extended Average (+20) Heal Test (6 SL) required. -10 penalty for 1d10 days after",
            conditions: ["Stunned"],
            healingRequirement: "Extended Heal Test",
            location: "Arm",
            severity: "severe"
          },
          "arm_severed_finger": {
            name: "Severed Finger",
            wounds: 4,
            effects: "Lose 1 finger - Amputation (Average). Gain 1 Bleeding Condition",
            conditions: ["Bleeding"],
            amputation: "Finger",
            location: "Arm",
            severity: "severe"
          },
          "arm_mangled_hand": {
            name: "Mangled Hand",
            wounds: 5,
            effects: "Gain 2 Bleeding, 2 Stunned Conditions. -20 to Dex Tests permanently. Amputation (Hard)",
            conditions: ["Bleeding", "Bleeding", "Stunned", "Stunned"],
            permanentEffects: ["-20 Dexterity Tests"],
            amputation: "Hand",
            location: "Arm",
            severity: "fatal"
          },
          "arm_severed_arm": {
            name: "Severed Arm",
            wounds: "Death",
            effects: "Arm chopped clean off. Gain Bleeding Condition. Make Challenging (+0) Endurance Test or die",
            conditions: ["Bleeding"],
            deathSave: "Challenging (+0) Endurance",
            amputation: "Arm",
            location: "Arm",
            severity: "fatal"
          },

          // BODY WOUNDS
          "body_dramatic_injury": {
            name: "Dramatic Injury", 
            wounds: "T",
            effects: "Gain 1 Bleeding Condition. +1 SL to social Tests once healed (once only)",
            conditions: ["Bleeding"],
            location: "Body",
            severity: "minor"
          },
          "body_barely_a_scratch": {
            name: "Barely a Scratch",
            wounds: 1,
            effects: "Gain 1 Bleeding Condition. No additional effects",
            conditions: ["Bleeding"],
            location: "Body",
            severity: "minor"
          },
          "body_flesh_wound": {
            name: "Flesh Wound",
            wounds: 2,
            effects: "Gain 1 Bleeding Condition. -10 to Agility for 1d10 rounds",
            conditions: ["Bleeding"],
            temporaryEffects: ["-10 Agility for 1d10 rounds"],
            location: "Body",
            severity: "minor"
          },
          "body_gut_blow": {
            name: "Gut Blow",
            wounds: 2,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. Winded for 1d10 rounds",
            conditions: ["Bleeding", "Stunned"],
            temporaryEffects: ["Winded for 1d10 rounds"],
            location: "Body",
            severity: "moderate"
          },
          "body_cracked_ribs": {
            name: "Cracked Ribs",
            wounds: 3,
            effects: "Gain 1 Bleeding, 1 Stunned Condition. Broken Bone (Minor) injury",
            conditions: ["Bleeding", "Stunned"],
            injuries: ["Broken Bone (Minor)"],
            location: "Body",
            severity: "moderate"
          },
          "body_winded": {
            name: "Winded",
            wounds: 3,
            effects: "Gain 2 Stunned Conditions. Cannot run for 1d10 rounds",
            conditions: ["Stunned", "Stunned"],
            temporaryEffects: ["Cannot run for 1d10 rounds"],
            location: "Body",
            severity: "moderate"
          },
          "body_broken_ribs": {
            name: "Broken Ribs",
            wounds: 4,
            effects: "Gain 2 Bleeding, 1 Stunned Condition. Broken Bone (Major) injury. -30 to Str, Ag Tests",
            conditions: ["Bleeding", "Bleeding", "Stunned"],
            injuries: ["Broken Bone (Major)"],
            location: "Body",
            severity: "severe"
          },
          "body_gut_wound": {
            name: "Gut Wound",
            wounds: 4,
            effects: "Contract Festering Wound disease. Gain 2 Bleeding Conditions",
            conditions: ["Bleeding", "Bleeding"],
            diseases: ["Festering Wound"],
            location: "Body",
            severity: "severe"
          },
          "body_ruptured_spleen": {
            name: "Ruptured Spleen",
            wounds: 5,
            effects: "Gain 3 Bleeding Conditions. Make Challenging (+0) Endurance Test each round or gain another Bleeding",
            conditions: ["Bleeding", "Bleeding", "Bleeding"],
            ongoingEffects: ["Endurance Test each round or gain Bleeding"],
            location: "Body",
            severity: "severe"
          },
          "body_pierced_heart": {
            name: "Pierced Heart",
            wounds: 5,
            effects: "Gain 3 Bleeding, 1 Unconscious Condition. Make Hard (-20) Endurance Test each round or die",
            conditions: ["Bleeding", "Bleeding", "Bleeding", "Unconscious"],
            ongoingEffects: ["Hard (-20) Endurance Test each round or die"],
            location: "Body",
            severity: "fatal"
          },
          "body_disemboweled": {
            name: "Disemboweled",
            wounds: "Death",
            effects: "Stomach split open, guts spill out. Make Very Hard (-30) Endurance Test or die instantly. Surgery required immediately",
            deathSave: "Very Hard (-30) Endurance",
            surgeryRequired: true,
            location: "Body",
            severity: "fatal"
          },

          // LEG WOUNDS
          "leg_dramatic_injury": {
            name: "Dramatic Injury",
            wounds: "T", 
            effects: "Gain 1 Bleeding Condition. +1 SL to social Tests once healed (once only)",
            conditions: ["Bleeding"],
            location: "Leg",
            severity: "minor"
          },
          "leg_bloody_mess": {
            name: "Bloody Mess",
            wounds: 1,
            effects: "Gain 1 Bleeding Condition. No additional effects",
            conditions: ["Bleeding"],
            location: "Leg",
            severity: "minor"
          },
          "leg_torn_muscles": {
            name: "Torn Muscles",
            wounds: 2,
            effects: "Gain 1 Bleeding Condition. Torn Muscle (Minor) injury. Half Move",
            conditions: ["Bleeding"],
            injuries: ["Torn Muscle (Minor)"],
            location: "Leg",
            severity: "minor"
          },
          "leg_bad_cut": {
            name: "Bad Cut",
            wounds: 2,
            effects: "Gain 1 Bleeding, 1 Prone Condition. Knocked down",
            conditions: ["Bleeding", "Prone"],
            location: "Leg",
            severity: "moderate"
          },
          "leg_torn_thigh": {
            name: "Torn Thigh",
            wounds: 3,
            effects: "Gain 1 Bleeding, 1 Prone Condition. Torn Muscle (Major) injury. Half Move",
            conditions: ["Bleeding", "Prone"],
            injuries: ["Torn Muscle (Major)"],
            location: "Leg",
            severity: "moderate"
          },
          "leg_broken_knee": {
            name: "Broken Knee",
            wounds: 4,
            effects: "Gain 1 Bleeding, 1 Prone, 1 Stunned Condition. Broken Bone (Major) injury",
            conditions: ["Bleeding", "Prone", "Stunned"],
            injuries: ["Broken Bone (Major)"],
            location: "Leg",
            severity: "severe"
          },
          "leg_broken_leg": {
            name: "Broken Leg",
            wounds: 4,
            effects: "Gain 2 Bleeding, 1 Prone, 2 Stunned Conditions. Broken Bone (Major) injury. Cannot move",
            conditions: ["Bleeding", "Bleeding", "Prone", "Stunned", "Stunned"],
            injuries: ["Broken Bone (Major)"],
            location: "Leg",
            severity: "severe"
          },
          "leg_crushed_foot": {
            name: "Crushed Foot",
            wounds: 4,
            effects: "Gain 1 Bleeding, 1 Prone, 1 Stunned Condition. -20 to Movement Tests permanently. Amputation (Hard)",
            conditions: ["Bleeding", "Prone", "Stunned"],
            permanentEffects: ["-20 Movement Tests"],
            amputation: "Foot",
            location: "Leg",
            severity: "severe"
          },
          "leg_mangled_leg": {
            name: "Mangled Leg",
            wounds: 5,
            effects: "Gain 2 Bleeding, 1 Prone, 2 Stunned Conditions. Leg unusable permanently. Amputation (Very Hard)",
            conditions: ["Bleeding", "Bleeding", "Prone", "Stunned", "Stunned"],
            permanentEffects: ["Leg unusable"],
            amputation: "Leg",
            location: "Leg",
            severity: "fatal"
          },
          "leg_severed_leg": {
            name: "Severed Leg",
            wounds: "Death",
            effects: "Leg chopped clean off. Gain 2 Bleeding Conditions. Make Challenging (+0) Endurance Test or die",
            conditions: ["Bleeding", "Bleeding"],
            deathSave: "Challenging (+0) Endurance",
            amputation: "Leg",
            location: "Leg",
            severity: "fatal"
          }
        };

        // Injury Types and Healing Mechanics
        const injuryTypes = {
          "Broken Bone (Minor)": {
            description: "Fractured bone, unusable until healed. 30+1d10 days to heal",
            effects: {
              "Head": "-30 to Language Tests",
              "Body": "-30 Strength and Agility, half Move",
              "Arm": "Arm unusable (as lost limb)",
              "Leg": "Leg unusable (as lost limb)"
            },
            healingTime: "30+1d10 days",
            testRequired: "Average (+20) Endurance Test when healed"
          },
          "Broken Bone (Major)": {
            description: "Badly broken bone at odd angle. 40+1d10 days to heal",
            effects: {
              "Head": "-30 to Language Tests",
              "Body": "-30 Strength and Agility, half Move", 
              "Arm": "Arm unusable (as lost limb)",
              "Leg": "Leg unusable (as lost limb)"
            },
            healingTime: "40+1d10 days",
            testRequired: "Challenging (+0) Endurance Test when healed. -10 penalty if failed"
          },
          "Torn Muscle (Minor)": {
            description: "Sprained/torn muscle. -10 to Tests using location",
            effects: {
              "Head": "-10 to head-based Tests",
              "Body": "-10 to body-based Tests",
              "Arm": "-10 to Tests using arm",
              "Leg": "-10 to Tests using leg, half Movement"
            },
            healingTime: "30 - Toughness Bonus days"
          },
          "Torn Muscle (Major)": {
            description: "Severely damaged muscle. -20 to Tests using location",
            effects: {
              "Head": "-20 to head-based Tests", 
              "Body": "-20 to body-based Tests",
              "Arm": "-20 to Tests using arm",
              "Leg": "-20 to Tests using leg, half Movement"
            },
            healingTime: "30 - TB days (-20), then 30 - TB days more (-10)"
          }
        };

        let talents = [];
        let srdTalents = [];
        let activeConditions = [];
        let srdConditions = [];
        let criticalWounds = []; // Active character critical wounds
        let spells = [];
        let srdSpells = [];

        // SRD Data (will be loaded from JSON files)
        let srdWeapons = [];
        let srdArmour = [];
        let srdAmmunition = [];

        // Define all available skills
        const allSkills = [
            // Basic Skills
            { name: "Art", characteristic: "Dex", type: "Basic", grouped: true },
            { name: "Athletics", characteristic: "Ag", type: "Basic", grouped: false },
            { name: "Bribery", characteristic: "Fel", type: "Basic", grouped: false },
            { name: "Charm", characteristic: "Fel", type: "Basic", grouped: false },
            { name: "Charm Animal", characteristic: "WP", type: "Basic", grouped: false },
            { name: "Climb", characteristic: "S", type: "Basic", grouped: false },
            { name: "Cool", characteristic: "WP", type: "Basic", grouped: false },
            { name: "Consume Alcohol", characteristic: "T", type: "Basic", grouped: false },
            { name: "Dodge", characteristic: "Ag", type: "Basic", grouped: false },
            { name: "Drive", characteristic: "Ag", type: "Basic", grouped: false },
            { name: "Endurance", characteristic: "T", type: "Basic", grouped: false },
            { name: "Entertain", characteristic: "Fel", type: "Basic", grouped: true },
            { name: "Gamble", characteristic: "Int", type: "Basic", grouped: false },
            { name: "Gossip", characteristic: "Fel", type: "Basic", grouped: false },
            { name: "Haggle", characteristic: "Fel", type: "Basic", grouped: false },
            { name: "Intimidate", characteristic: "S", type: "Basic", grouped: false },
            { name: "Intuition", characteristic: "I", type: "Basic", grouped: false },
            { name: "Leadership", characteristic: "Fel", type: "Basic", grouped: false },
            { name: "Melee", characteristic: "WS", type: "Basic", grouped: true },
            { name: "Navigation", characteristic: "I", type: "Basic", grouped: false },
            { name: "Outdoor Survival", characteristic: "Int", type: "Basic", grouped: false },
            { name: "Perception", characteristic: "I", type: "Basic", grouped: false },
            { name: "Ride", characteristic: "Ag", type: "Basic", grouped: true },
            { name: "Row", characteristic: "S", type: "Basic", grouped: false },
            { name: "Stealth", characteristic: "Ag", type: "Basic", grouped: true },
            
            // Advanced Skills
            { name: "Animal Care", characteristic: "Int", type: "Advanced", grouped: false },
            { name: "Animal Training", characteristic: "Int", type: "Advanced", grouped: true },
            { name: "Channelling", characteristic: "WP", type: "Advanced", grouped: true },
            { name: "Evaluate", characteristic: "Int", type: "Advanced", grouped: false },
            { name: "Heal", characteristic: "Int", type: "Advanced", grouped: false },
            { name: "Language", characteristic: "Int", type: "Advanced", grouped: true },
            { name: "Lore", characteristic: "Int", type: "Advanced", grouped: true },
            { name: "Perform", characteristic: "Ag", type: "Advanced", grouped: true },
            { name: "Pick Lock", characteristic: "Dex", type: "Advanced", grouped: false },
            { name: "Play", characteristic: "Dex", type: "Advanced", grouped: true },
            { name: "Pray", characteristic: "Fel", type: "Advanced", grouped: false },
            { name: "Ranged", characteristic: "BS", type: "Advanced", grouped: true },
            { name: "Research", characteristic: "Int", type: "Advanced", grouped: false },
            { name: "Sail", characteristic: "Ag", type: "Advanced", grouped: false },
            { name: "Secret Signs", characteristic: "Int", type: "Advanced", grouped: true },
            { name: "Set Trap", characteristic: "Dex", type: "Advanced", grouped: false },
            { name: "Sleight of Hand", characteristic: "Dex", type: "Advanced", grouped: false },
            { name: "Swim", characteristic: "S", type: "Advanced", grouped: false },
            { name: "Track", characteristic: "I", type: "Advanced", grouped: false },
            { name: "Trade", characteristic: "Dex", type: "Advanced", grouped: true }
        ];

        // Get default basic skills (ungrouped only)
        function getDefaultSkills() {
            return allSkills.filter(skill => skill.type === "Basic" && !skill.grouped);
        }

        // Auto-calculate current characteristics
        const characteristics = ['ws', 'bs', 's', 't', 'i', 'ag', 'dex', 'int', 'wp', 'fel'];
        
        characteristics.forEach(char => {
            const initial = document.getElementById(`${char}-initial`);
            const advances = document.getElementById(`${char}-advances`);
            const current = document.getElementById(`${char}-current`);
            
            function updateCurrent() {
                const init = parseInt(initial.value) || 0;
                const adv = parseInt(advances.value) || 0;
                let currentValue = init + adv;
                let penalties = [];
                let totalPenalty = 0;
                
                // Apply encumbrance penalty to Agility
                if (char === 'ag') {
                    const encStatus = document.getElementById('enc-status');
                    const agilityPenalty = parseInt(encStatus?.getAttribute('data-agility-penalty') || 0);
                    
                    if (agilityPenalty > 0) {
                        // Apply penalty with minimum of 10 for triple encumbrance
                        if (agilityPenalty === 20) {
                            currentValue = Math.max(10, currentValue - agilityPenalty);
                        } else {
                            currentValue = currentValue - agilityPenalty;
                        }
                        penalties.push(`Encumbrance: -${agilityPenalty}`);
                        totalPenalty += agilityPenalty;
                    }
                }
                
                // Apply critical wound penalties
                if (typeof window.getCriticalWoundPenalties === 'function') {
                    const woundPenalties = window.getCriticalWoundPenalties();
                    const charMap = {
                        'ws': 'WS', 'bs': 'BS', 's': 'S', 't': 'T', 'i': 'I', 
                        'ag': 'Ag', 'dex': 'Dex', 'int': 'Int', 'wp': 'WP', 'fel': 'Fel'
                    };
                    
                    const mappedChar = charMap[char];
                    if (woundPenalties.characteristics[mappedChar]) {
                        const woundPenalty = Math.abs(woundPenalties.characteristics[mappedChar]);
                        currentValue = Math.max(0, currentValue - woundPenalty);
                        penalties.push(`Critical Wounds: -${woundPenalty}`);
                        totalPenalty += woundPenalty;
                    }
                }
                
                // Update display styling and tooltips
                if (totalPenalty > 0) {
                    current.style.color = 'red';
                    current.title = `Base: ${init + adv}, ${penalties.join(', ')}`;
                } else if (char !== 'ag') { // Don't clear ag styling if it was set by encumbrance
                    current.style.color = '';
                    current.title = '';
                }
                
                current.value = currentValue;
                
                // Update all skill totals when characteristics change
                updateAllSkillTotals();
                
                // Update XP cost displays
                if (window.updateAdvanceCosts) {
                    window.updateAdvanceCosts();
                }
                
                // Update encumbrance when Strength or Toughness changes
                if (char === 's' || char === 't') {
                    updateEncumbrance();
                }
            }
            
            initial.addEventListener('input', updateCurrent);
            advances.addEventListener('input', updateCurrent);
            
            // Store the update function for later use
            current.updateFunction = updateCurrent;
        });

        // Auto-update max displays when fate/resilience change via direct input
        let previousFate = 0;
        let previousResilience = 0;
        
        document.getElementById('fate').addEventListener('input', () => {
            const fate = parseInt(document.getElementById('fate').value) || 0;
            const change = fate - previousFate;
            previousFate = fate;
            
            window.updateFateFortuneResilienceResolveDisplay();
            
            // Apply the same logic as the +/- buttons
            const fortuneCurrentField = document.getElementById('fortune-current');
            const currentFortune = parseInt(fortuneCurrentField.value) || 0;
            
            if (change > 0) {
                // Fate increased - add the same amount to current fortune
                fortuneCurrentField.value = currentFortune + change;
            } else if (currentFortune > fate) {
                // Fate decreased - cap current fortune at new max
                fortuneCurrentField.value = fate;
            }
        });

        document.getElementById('resilience').addEventListener('input', () => {
            const resilience = parseInt(document.getElementById('resilience').value) || 0;
            const change = resilience - previousResilience;
            previousResilience = resilience;
            
            window.updateFateFortuneResilienceResolveDisplay();
            
            // Apply the same logic as the +/- buttons
            const resolveCurrentField = document.getElementById('resolve-current');
            const currentResolve = parseInt(resolveCurrentField.value) || 0;
            
            if (change > 0) {
                // Resilience increased - add the same amount to current resolve
                resolveCurrentField.value = currentResolve + change;
            } else if (currentResolve > resilience) {
                // Resilience decreased - cap current resolve at new max
                resolveCurrentField.value = resilience;
            }
        });

        // Auto-calculate movement values
        const movement = document.getElementById('movement');
        const walk = document.getElementById('walk');
        const run = document.getElementById('run');
        
        movement.addEventListener('input', () => {
            const moveVal = parseInt(movement.value) || 0;
            
            // Store this as the base movement value
            movement.setAttribute('data-base-movement', moveVal);
            
            // Recalculate walk and run
            walk.value = moveVal * 2;
            run.value = moveVal * 4;
            
            // Recalculate encumbrance to apply any penalties
            updateEncumbrance();
        });

        // XP System Management - will be initialized in DOMContentLoaded
        let xpTotal, xpSpent;
        
        window.updateXPDisplay = function() {
            if (!xpTotal || !xpSpent) return; // Guard against early calls
            
            const total = parseInt(xpTotal.value) || 0;
            const spent = parseInt(xpSpent.value) || 0;
            const current = total - spent;
            
            document.getElementById('xp-total-display').textContent = total;
            document.getElementById('xp-current-display').textContent = current;
            document.getElementById('xp-spent-display').textContent = spent;
            
            // Update all advance cost displays
            window.updateAdvanceCosts();
        }
        
        // XP Earning Dialog
        window.openXPEarnDialog = function() {
            const xpAmount = prompt('Enter XP earned this session:', '0');
            if (xpAmount !== null && !isNaN(xpAmount) && parseInt(xpAmount) >= 0) {
                const sessionNote = prompt('Session note (optional):', '');
                window.addSessionXP(parseInt(xpAmount), sessionNote);
            }
        }
        
        window.addSessionXP = function(amount, note) {
            if (!xpTotal) return; // Guard against early calls
            
            const currentTotal = parseInt(xpTotal.value) || 0;
            xpTotal.value = currentTotal + amount;
            window.updateXPDisplay();
            
            if (amount > 0) {
                alert(`Added ${amount} XP! Total XP: ${parseInt(xpTotal.value)}`);
            }
        }
        
        // XP Cost Calculation Functions
        window.getCharacteristicCost = function(advances) {
            const costs = [
                {min: 0, max: 5, cost: 25},
                {min: 6, max: 10, cost: 30},
                {min: 11, max: 15, cost: 40},
                {min: 16, max: 20, cost: 50},
                {min: 21, max: 25, cost: 70},
                {min: 26, max: 30, cost: 90},
                {min: 31, max: 35, cost: 120},
                {min: 36, max: 40, cost: 150},
                {min: 41, max: 45, cost: 190},
                {min: 46, max: 50, cost: 230},
                {min: 51, max: 55, cost: 280},
                {min: 56, max: 60, cost: 330},
                {min: 61, max: 65, cost: 390},
                {min: 66, max: 70, cost: 450}
            ];
            
            for (const range of costs) {
                if (advances >= range.min && advances <= range.max) {
                    return range.cost;
                }
            }
            return 520; // 70+ cost
        }
        
        window.getSkillCost = function(advances) {
            const costs = [
                {min: 0, max: 5, cost: 10},
                {min: 6, max: 10, cost: 15},
                {min: 11, max: 15, cost: 20},
                {min: 16, max: 20, cost: 30},
                {min: 21, max: 25, cost: 40},
                {min: 26, max: 30, cost: 60},
                {min: 31, max: 35, cost: 80},
                {min: 36, max: 40, cost: 110},
                {min: 41, max: 45, cost: 140},
                {min: 46, max: 50, cost: 180},
                {min: 51, max: 55, cost: 220},
                {min: 56, max: 60, cost: 270},
                {min: 61, max: 65, cost: 320},
                {min: 66, max: 70, cost: 380}
            ];
            
            for (const range of costs) {
                if (advances >= range.min && advances <= range.max) {
                    return range.cost;
                }
            }
            return 440; // 70+ cost
        }
        
        window.getTalentCost = function(advances) {
            return 100 + (100 * advances);
        }
        
        window.canAffordAdvance = function(cost) {
            if (!xpTotal || !xpSpent) return false; // Guard against early calls
            
            const total = parseInt(xpTotal.value) || 0;
            const spent = parseInt(xpSpent.value) || 0;
            const current = total - spent;
            return current >= cost;
        }
        
        window.spendXP = function(amount, description) {
            if (!xpTotal || !xpSpent) return false; // Guard against early calls
            
            if (!window.canAffordAdvance(amount)) {
                const total = parseInt(xpTotal.value) || 0;
                const spent = parseInt(xpSpent.value) || 0;
                const current = total - spent;
                alert(`Insufficient XP! Need ${amount} XP, only have ${current} available.`);
                return false;
            }
            
            const currentSpent = parseInt(xpSpent.value) || 0;
            xpSpent.value = currentSpent + amount;
            window.updateXPDisplay();
            return true;
        }
        
        window.updateAdvanceCosts = function() {
            // Update characteristic advance cost displays
            characteristics.forEach(char => {
                const advancesField = document.getElementById(`${char}-advances`);
                if (advancesField) {
                    const advances = parseInt(advancesField.value) || 0;
                    const cost = window.getCharacteristicCost(advances);
                    const costDisplay = document.getElementById(`${char}-cost-display`);
                    if (costDisplay) {
                        costDisplay.textContent = `(${cost} XP)`;
                        const button = costDisplay.parentElement.querySelector('button');
                        if (button) {
                            if (window.canAffordAdvance(cost)) {
                                button.style.opacity = '1';
                                button.disabled = false;
                            } else {
                                button.style.opacity = '0.5';
                                button.disabled = true;
                            }
                        }
                    }
                }
            });
            
            // Update skill advance cost displays and button states
            Object.keys(characterSkills).forEach(skillKey => {
                const skillData = characterSkills[skillKey];
                const cleanKey = skillKey.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
                const cost = window.getSkillCost(skillData.advances || 0);
                const costDisplay = document.getElementById(`${cleanKey}-cost-display`);
                if (costDisplay) {
                    costDisplay.textContent = `(${cost} XP)`;
                    const button = costDisplay.parentElement.querySelector('button');
                    if (button) {
                        const canAfford = window.canAffordAdvance(cost);
                        const maxAdvances = (skillData.advances || 0) >= 5;
                        
                        if (canAfford && !maxAdvances) {
                            button.style.opacity = '1';
                            button.disabled = false;
                        } else {
                            button.style.opacity = '0.5';
                            button.disabled = true;
                        }
                    }
                }
            });
            
            // Update talent cost displays and button states
            talents.forEach((talent, index) => {
                const currentTimes = talent.timesTaken || 1;
                const cleanTalentKey = talent.displayName.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
                const cost = window.getTalentCost(currentTimes); // Cost for next advance
                const costDisplay = document.getElementById(`${cleanTalentKey}-cost-display`);
                
                if (costDisplay) {
                    costDisplay.textContent = `(${cost} XP)`;
                    const button = costDisplay.parentElement.querySelector('button');
                    if (button) {
                        const canAfford = window.canAffordAdvance(cost);
                        const maxAllowed = talent.max === "No Limit" ? 999 : parseInt(talent.max);
                        const canTakeMore = currentTimes < maxAllowed;
                        
                        if (canAfford && canTakeMore) {
                            button.style.opacity = '1';
                            button.disabled = false;
                        } else {
                            button.style.opacity = '0.5';
                            button.disabled = true;
                        }
                    }
                }
            });
        }
        
        // Characteristic Advancement with XP Integration
        window.advanceCharacteristic = function(charCode) {
            if (!xpTotal || !xpSpent) return; // Guard against early calls
            
            const advancesField = document.getElementById(`${charCode}-advances`);
            const currentAdvances = parseInt(advancesField.value) || 0;
            const cost = window.getCharacteristicCost(currentAdvances);
            const total = parseInt(xpTotal.value) || 0;
            const spent = parseInt(xpSpent.value) || 0;
            const current = total - spent;
            
            const charNames = {
                'ws': 'Weapon Skill',
                'bs': 'Ballistic Skill', 
                's': 'Strength',
                't': 'Toughness',
                'i': 'Initiative',
                'ag': 'Agility',
                'dex': 'Dexterity',
                'int': 'Intelligence',
                'wp': 'Willpower',
                'fel': 'Fellowship'
            };
            
            if (!window.canAffordAdvance(cost)) {
                alert(`Insufficient XP! Need ${cost} XP to advance ${charNames[charCode]}, only have ${current} available.`);
                return;
            }
            
            if (confirm(`Advance ${charNames[charCode]} for ${cost} XP? (Current XP: ${current})`)) {
                if (window.spendXP(cost, `${charNames[charCode]} advance`)) {
                    advancesField.value = currentAdvances + 1;
                    advancesField.dispatchEvent(new Event('input'));
                    alert(`${charNames[charCode]} advanced! Spent ${cost} XP.`);
                }
            }
        }
        
        // Skill Advancement with XP Integration
        window.advanceSkill = function(skillKey) {
            if (!xpTotal || !xpSpent) return; // Guard against early calls
            
            const skillData = characterSkills[skillKey] || { career: false, advances: 0, notes: '' };
            const currentAdvances = skillData.advances || 0;
            
            if (currentAdvances >= 5) {
                alert('Skills cannot exceed 5 advances!');
                return;
            }
            
            const cost = window.getSkillCost(currentAdvances);
            const total = parseInt(xpTotal.value) || 0;
            const spent = parseInt(xpSpent.value) || 0;
            const current = total - spent;
            
            // Find skill display name
            let skillDisplayName = skillKey;
            const allSkills = [...getDefaultSkills(), ...addedSkills];
            const skillInfo = allSkills.find(s => s.key === skillKey || s.name === skillKey);
            if (skillInfo) {
                skillDisplayName = skillInfo.displayName || skillInfo.name;
            }
            
            if (!window.canAffordAdvance(cost)) {
                alert(`Insufficient XP! Need ${cost} XP to advance ${skillDisplayName}, only have ${current} available.`);
                return;
            }
            
            if (confirm(`Advance ${skillDisplayName} for ${cost} XP? (Current XP: ${current})`)) {
                if (window.spendXP(cost, `${skillDisplayName} skill advance`)) {
                    window.updateSkillData(skillKey, 'advances', currentAdvances + 1);
                    window.displaySkills(); // Refresh the display
                    alert(`${skillDisplayName} advanced! Spent ${cost} XP.`);
                }
            }
        }
        
        // Talent Advancement with XP Integration
        window.advanceTalent = function(talentIndex) {
            if (!xpTotal || !xpSpent) return; // Guard against early calls
            
            const talent = talents[talentIndex];
            if (!talent) return;
            
            const currentTimes = talent.timesTaken || 1;
            const maxAllowed = talent.max === "No Limit" ? 999 : parseInt(talent.max);
            
            if (currentTimes >= maxAllowed) {
                alert(`${talent.displayName} is already at maximum!`);
                return;
            }
            
            // Cost for next advance: current times taken represents advances already made
            const cost = window.getTalentCost(currentTimes);
            const total = parseInt(xpTotal.value) || 0;
            const spent = parseInt(xpSpent.value) || 0;
            const current = total - spent;
            
            // Create a custom confirmation dialog with free option
            const canAfford = window.canAffordAdvance(cost);
            let confirmationMessage;
            
            if (canAfford) {
                confirmationMessage = `Take ${talent.displayName} again for ${cost} XP? (Current XP: ${current})\n\nClick OK to spend XP, or Cancel to add for free (mutation/story reward).`;
            } else {
                confirmationMessage = `Insufficient XP! Need ${cost} XP to take ${talent.displayName} again, only have ${current} available.\n\nClick OK to add for free (mutation/story reward), or Cancel to abort.`;
            }
            
            const userChoice = confirm(confirmationMessage);
            
            if (userChoice) {
                if (canAfford) {
                    // Normal XP purchase
                    if (window.spendXP(cost, `${talent.displayName} talent advance`)) {
                        talent.timesTaken = currentTimes + 1;
                        window.displayTalents(); // Refresh the display
                        alert(`${talent.displayName} taken again! Spent ${cost} XP.`);
                    }
                } else {
                    // Free addition (insufficient XP scenario)
                    talent.timesTaken = currentTimes + 1;
                    window.displayTalents(); // Refresh the display
                    alert(`${talent.displayName} taken again for FREE!`);
                }
            } else {
                if (canAfford) {
                    // User chose free option when they could afford it
                    if (confirm(`Add ${talent.displayName} again for FREE? (mutation/story reward)`)) {
                        talent.timesTaken = currentTimes + 1;
                        window.displayTalents(); // Refresh the display
                        alert(`${talent.displayName} taken again for FREE!`);
                    }
                }
                // If they can't afford and clicked cancel, just return
            }
        }
        
        // Fate/Fortune/Resilience/Resolve System
        window.updateFateFortuneResilienceResolveDisplay = function() {
            // Update Fortune max display
            const fate = parseInt(document.getElementById('fate').value) || 0;
            const fortuneMax = document.getElementById('fortune-max');
            fortuneMax.textContent = fate;
            
            // Update Resolve max display  
            const resilience = parseInt(document.getElementById('resilience').value) || 0;
            const resolveMax = document.getElementById('resolve-max');
            resolveMax.textContent = resilience;
        }
        
        window.updateFate = function(change) {
            const fateField = document.getElementById('fate');
            const currentFate = parseInt(fateField.value) || 0;
            const newFate = Math.max(0, currentFate + change); // No max limit for fate
            
            fateField.value = newFate;
            
            // Update max fortune display
            const fortuneMax = document.getElementById('fortune-max');
            fortuneMax.textContent = newFate;
            
            // When fate increases, increase current fortune by the same amount
            // When fate decreases, cap current fortune at new max
            const fortuneCurrentField = document.getElementById('fortune-current');
            const currentFortune = parseInt(fortuneCurrentField.value) || 0;
            
            if (change > 0) {
                // Fate increased - add the same amount to current fortune
                fortuneCurrentField.value = currentFortune + change;
            } else if (currentFortune > newFate) {
                // Fate decreased - cap current fortune at new max
                fortuneCurrentField.value = newFate;
            }
            
            window.updateFateFortuneResilienceResolveDisplay();
        }
        
        window.updateFortune = function(change) {
            const fortuneCurrentField = document.getElementById('fortune-current');
            const currentFortune = parseInt(fortuneCurrentField.value) || 0;
            const maxFortune = parseInt(document.getElementById('fate').value) || 0;
            
            const newFortune = Math.max(0, Math.min(maxFortune, currentFortune + change));
            fortuneCurrentField.value = newFortune;
        }
        
        window.restoreFortune = function() {
            const maxFortune = parseInt(document.getElementById('fate').value) || 0;
            
            if (confirm(`Restore Fortune to ${maxFortune}? (usually done at session start)`)) {
                document.getElementById('fortune-current').value = maxFortune;
            }
        }
        
        window.updateResilience = function(change) {
            const resilienceField = document.getElementById('resilience');
            const currentResilience = parseInt(resilienceField.value) || 0;
            const newResilience = Math.max(0, currentResilience + change); // No max limit for resilience
            
            resilienceField.value = newResilience;
            
            // Update max resolve display
            const resolveMax = document.getElementById('resolve-max');
            resolveMax.textContent = newResilience;
            
            // When resilience increases, increase current resolve by the same amount
            // When resilience decreases, cap current resolve at new max
            const resolveCurrentField = document.getElementById('resolve-current');
            const currentResolve = parseInt(resolveCurrentField.value) || 0;
            
            if (change > 0) {
                // Resilience increased - add the same amount to current resolve
                resolveCurrentField.value = currentResolve + change;
            } else if (currentResolve > newResilience) {
                // Resilience decreased - cap current resolve at new max
                resolveCurrentField.value = newResilience;
            }
            
            window.updateFateFortuneResilienceResolveDisplay();
        }
        
        window.updateResolve = function(change) {
            const resolveCurrentField = document.getElementById('resolve-current');
            const currentResolve = parseInt(resolveCurrentField.value) || 0;
            const maxResolve = parseInt(document.getElementById('resilience').value) || 0;
            
            const newResolve = Math.max(0, Math.min(maxResolve, currentResolve + change));
            resolveCurrentField.value = newResolve;
        }
        
        // XP display will be initialized in DOMContentLoaded

        // Skills functionality
        window.displaySkills = function() {
            const tbody = document.getElementById('skills-tbody');
            const filter = document.getElementById('skills-filter').value;
            tbody.innerHTML = '';
            
            // Combine default skills and added skills
            let allDisplaySkills = [];
            
            // Add default basic skills (ungrouped)
            getDefaultSkills().forEach(skill => {
                allDisplaySkills.push({
                    key: skill.name,
                    name: skill.name,
                    displayName: skill.name,
                    characteristic: skill.characteristic,
                    type: skill.type,
                    canDelete: false
                });
            });
            
            // Add manually added skills
            addedSkills.forEach(skill => {
                allDisplaySkills.push({
                    key: skill.key,
                    name: skill.name,
                    displayName: skill.displayName,
                    characteristic: skill.characteristic,
                    type: skill.type,
                    canDelete: true
                });
            });
            
            // Filter skills
            if (filter !== 'all') {
                allDisplaySkills = allDisplaySkills.filter(skill => {
                    if (filter === 'career') return characterSkills[skill.key]?.career || false;
                    if (filter === 'basic') return skill.type === 'Basic';
                    if (filter === 'advanced') return skill.type === 'Advanced';
                    return true;
                });
            }
            
            // Sort alphabetically
            allDisplaySkills.sort((a, b) => a.displayName.localeCompare(b.displayName));
            
            // Display skills
            allDisplaySkills.forEach(skill => {
                const skillData = characterSkills[skill.key] || { career: false, advances: 0, notes: '' };
                
                const row = document.createElement('tr');
                const cleanKey = skill.key.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
                const cost = window.getSkillCost(skillData.advances);
                
                row.innerHTML = `
                    <td class="skill-name-cell">${skill.displayName}</td>
                    <td>${skill.characteristic}</td>
                    <td>${skill.type}</td>
                    <td><input type="checkbox" ${skillData.career ? 'checked' : ''} onchange="updateSkillData('${skill.key}', 'career', this.checked)"></td>
                    <td><input type="number" value="${skillData.advances}" min="0" readonly style="width: 50px; background: #f5f5f5;"></td>
                    <td class="skill-total" id="skill-total-${cleanKey}">${calculateSkillTotal(skill, skill.key)}</td>
                    <td style="text-align: center;">
                        <button onclick="window.advanceSkill('${skill.key}')" style="padding: 5px 8px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                        <span id="${cleanKey}-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(${cost} XP)</span>
                    </td>
                    <td><input type="text" value="${skillData.notes}" placeholder="Notes..." onchange="updateSkillData('${skill.key}', 'notes', this.value)" style="width: 100%; border: none; font-size: 11px;"></td>
                    <td>${skill.canDelete ? `<button class="advance-btn" onclick="removeSkill('${skill.key}')" style="background: #d44; color: white; width: 20px;">×</button>` : ''}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        window.calculateSkillTotal = function(skill, skillKey) {
            const skillData = characterSkills[skillKey] || { advances: 0 };
            const charValue = parseInt(document.getElementById(`${skill.characteristic.toLowerCase()}-current`).value) || 0;
            const advances = skillData.advances || 0;
            let baseTotal = charValue + advances;
            
            // Apply critical wound penalties to skills
            if (typeof window.getSkillPenaltiesFromWounds === 'function') {
                const woundPenalties = window.getSkillPenaltiesFromWounds(skillKey);
                baseTotal = Math.max(0, baseTotal - woundPenalties.totalPenalty);
                
                // Update visual indicators for penalized skills
                setTimeout(() => {
                    const cleanKey = skillKey.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
                    const totalElement = document.getElementById(`skill-total-${cleanKey}`);
                    if (totalElement && woundPenalties.totalPenalty > 0) {
                        totalElement.style.color = 'red';
                        totalElement.title = `Base: ${charValue + advances}, Critical Wounds: -${woundPenalties.totalPenalty}\n${woundPenalties.penalties.join('\n')}`;
                    } else if (totalElement) {
                        totalElement.style.color = '';
                        totalElement.title = '';
                    }
                }, 10);
            }
            
            return baseTotal;
        }

        window.updateSkillData = function(skillKey, property, value) {
            if (!characterSkills[skillKey]) {
                characterSkills[skillKey] = { career: false, advances: 0, notes: '' };
            }
            characterSkills[skillKey][property] = value;
            
            updateSkillTotal(skillKey);
        }

        window.updateSkillTotal = function(skillKey) {
            // Find the skill
            let skill = getDefaultSkills().find(s => s.name === skillKey);
            if (!skill) {
                skill = addedSkills.find(s => s.key === skillKey);
            }
            
            if (skill) {
                // Match the ID generation from displaySkills function
                const cleanKey = skillKey.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
                const totalElement = document.getElementById(`skill-total-${cleanKey}`);
                if (totalElement) {
                    totalElement.textContent = calculateSkillTotal(skill, skillKey);
                }
            }
        }

        window.updateAllSkillTotals = function() {
            // Update default skills
            getDefaultSkills().forEach(skill => {
                updateSkillTotal(skill.name);
            });
            
            // Update added skills
            addedSkills.forEach(skill => {
                updateSkillTotal(skill.key);
            });
        }

        // Add skill modal functions
        window.addSkill = function() {
            populateSkillSelect();
            document.getElementById('add-skill-modal').style.display = 'block';
        }

        window.populateSkillSelect = function() {
            const select = document.getElementById('skill-select');
            select.innerHTML = '<option value="">Select a skill...</option>';
            
            // Only show skills that are either:
            // 1. Grouped skills (requiring specialisation)
            // 2. Advanced skills (not automatically available)
            // Exclude basic ungrouped skills as they're already shown by default
            allSkills.forEach(skill => {
                // Skip basic ungrouped skills - they're already in the default list
                if (skill.type === 'Basic' && !skill.grouped) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = skill.name;
                option.textContent = skill.name + (skill.grouped ? ' (requires specialisation)' : '');
                option.dataset.grouped = skill.grouped;
                select.appendChild(option);
            });
        }

        window.toggleSpecialisationField = function() {
            const select = document.getElementById('skill-select');
            const selectedOption = select.options[select.selectedIndex];
            const specialisationField = document.getElementById('specialisation-field');
            
            if (selectedOption && selectedOption.dataset.grouped === 'true') {
                specialisationField.style.display = 'block';
            } else {
                specialisationField.style.display = 'none';
                document.getElementById('specialisation-input').value = '';
            }
        }

        window.confirmAddSkill = function() {
            const skillName = document.getElementById('skill-select').value;
            const specialisation = document.getElementById('specialisation-input').value.trim();
            
            if (!skillName) {
                alert('Please select a skill');
                return;
            }
            
            const baseSkill = allSkills.find(s => s.name === skillName);
            if (!baseSkill) {
                alert('Invalid skill selected');
                return;
            }
            
            // Check if specialisation is required
            if (baseSkill.grouped && !specialisation) {
                alert(`This skill requires a specialisation (e.g., ${skillName} (Battle), ${skillName} (Bow))`);
                return;
            }
            
            // Create the skill key and display name
            let skillKey, displayName;
            if (specialisation) {
                skillKey = `${skillName} (${specialisation})`;
                displayName = `${skillName} (${specialisation})`;
            } else {
                skillKey = skillName;
                displayName = skillName;
            }
            
            // Check if this exact skill already exists
            if (addedSkills.find(s => s.key === skillKey)) {
                alert('This skill is already added');
                return;
            }
            
            // Add the skill
            addedSkills.push({
                key: skillKey,
                name: skillName,
                displayName: displayName,
                characteristic: baseSkill.characteristic,
                type: baseSkill.type,
                specialisation: specialisation
            });
            
            // Initialize skill data
            characterSkills[skillKey] = { career: false, advances: 0, notes: '' };
            
            displaySkills();
            closeAddSkillModal();
        }

        // Talent Management Functions
        window.addTalent = function() {
            populateTalentSelect();
            document.getElementById('add-talent-modal').style.display = 'block';
            document.getElementById('talent-search-modal').value = '';
            document.getElementById('talent-search-modal').focus();
        }

        window.populateTalentSelect = function() {
            const select = document.getElementById('talent-select');
            select.innerHTML = '';
            
            const sortedTalents = [...srdTalents].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedTalents.forEach(talent => {
                const option = document.createElement('option');
                option.value = talent.name;
                option.textContent = `${talent.name} (Max: ${talent.max})`;
                option.dataset.talent = JSON.stringify(talent);
                select.appendChild(option);
            });
        }

        window.filterTalentOptions = function() {
            console.log('filterTalentOptions called!');
            
            const searchInput = document.getElementById('talent-search-modal');
            const select = document.getElementById('talent-select');
            
            if (!searchInput || !select) {
                console.error('Elements not found:', { searchInput, select });
                return;
            }
            
            const searchText = searchInput.value.toLowerCase();
            const options = select.options;
            
            console.log('Searching for:', searchText);
            console.log('Total options:', options.length);
            
            if (options.length === 0) {
                console.log('No options available - talent data may not be loaded');
                return;
            }
            
            let matchCount = 0;
            let firstMatch = null;
            
            for (let i = 0; i < options.length; i++) {
                try {
                    const talent = JSON.parse(options[i].dataset.talent);
                    const matches = searchText === '' || 
                                   (talent.name && talent.name.toLowerCase().includes(searchText)) ||
                                   (talent.description && talent.description.toLowerCase().includes(searchText)) ||
                                   (talent.tests && talent.tests.toLowerCase().includes(searchText));
                    
                    options[i].style.display = matches ? '' : 'none';
                    
                    if (matches) {
                        matchCount++;
                        if (!firstMatch) {
                            firstMatch = options[i];
                        }
                    }
                } catch (e) {
                    console.error('Error parsing talent data for option', i, ':', e);
                    options[i].style.display = 'none';
                }
            }
            
            // Select first match if any
            if (firstMatch && matchCount > 0) {
                firstMatch.selected = true;
                window.showTalentDetails();
            }
            
            console.log('Matches found:', matchCount);
        }

window.showTalentDetails = function() {
    const select = document.getElementById('talent-select');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption) return;
    
    const talent = JSON.parse(selectedOption.dataset.talent);
    const detailsDiv = document.getElementById('talent-details');
    const customisationDiv = document.getElementById('talent-customisation');
    const timesDiv = document.getElementById('talent-times-taken');
    
    document.getElementById('detail-talent-name').textContent = talent.name;
    document.getElementById('detail-talent-max').textContent = talent.max;
    document.getElementById('detail-talent-tests').textContent = talent.tests || 'N/A';
    document.getElementById('detail-talent-description').textContent = talent.description;
    
    detailsDiv.style.display = 'block';
    
    if (talent.customisable) {
        customisationDiv.style.display = 'block';
    } else {
        customisationDiv.style.display = 'none';
        document.getElementById('talent-customisation-input').value = '';
    }
    
    const maxTimes = talent.max === "1" ? 1 : 10;
    document.getElementById('talent-times-input').max = maxTimes;
    
    timesDiv.style.display = talent.max === "1" ? 'none' : 'block';
}

window.confirmAddTalent = function() {
    const select = document.getElementById('talent-select');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption) {
        alert('Please select a talent');
        return;
    }
    
    const talentData = JSON.parse(selectedOption.dataset.talent);
    const customisation = document.getElementById('talent-customisation-input').value.trim();
    const timesTaken = parseInt(document.getElementById('talent-times-input').value) || 1;
    
    if (talentData.customisable && !customisation) {
        alert(`Please specify the type for ${talentData.name}`);
        return;
    }
    
    // Check if XP cost should be overridden (free talent)
    const isFreeTalent = document.getElementById('talent-xp-override').checked;
    const displayName = customisation ? `${talentData.name} (${customisation})` : talentData.name;
    
    // Calculate XP cost for the talent(s) being added (unless it's free)
    let totalCost = 0;
    
    if (!isFreeTalent) {
        // Check if this exact talent already exists
        const existingIndex = talents.findIndex(t => 
            t.name === talentData.name && t.customisation === customisation
        );
        
        if (existingIndex !== -1) {
            // Adding to existing talent
            const currentTimes = talents[existingIndex].timesTaken;
            const maxAllowed = parseInt(talentData.max) || 10;
            const actualTimesToAdd = Math.min(timesTaken, maxAllowed - currentTimes);
            
            if (actualTimesToAdd <= 0) {
                alert(`You already have the maximum number of ${displayName}`);
                return;
            }
            
            // Calculate cost for each additional time
            for (let i = 0; i < actualTimesToAdd; i++) {
                totalCost += window.getTalentCost(currentTimes + i);
            }
        } else {
            // New talent - calculate cost for all times
            for (let i = 0; i < timesTaken; i++) {
                totalCost += window.getTalentCost(i);
            }
        }
        
        // Check if player can afford it
        const total = parseInt(document.getElementById('xp-total').value) || 0;
        const spent = parseInt(document.getElementById('xp-spent').value) || 0;
        const current = total - spent;
        
        if (!window.canAffordAdvance(totalCost)) {
            alert(`Insufficient XP! Need ${totalCost} XP to add ${displayName}${timesTaken > 1 ? ` (${timesTaken} times)` : ''}, only have ${current} available.`);
            return;
        }
        
        // Confirm the purchase
        const confirmMessage = timesTaken > 1 ? 
            `Add ${displayName} ${timesTaken} times for ${totalCost} XP? (Current XP: ${current})` :
            `Add ${displayName} for ${totalCost} XP? (Current XP: ${current})`;
            
        if (!confirm(confirmMessage)) {
            return;
        }
        
        // Spend the XP
        if (!window.spendXP(totalCost, `${displayName} talent${timesTaken > 1 ? ` (${timesTaken} times)` : ''}`)) {
            return;
        }
    } else {
        // Free talent - just confirm the addition
        const confirmMessage = timesTaken > 1 ? 
            `Add ${displayName} ${timesTaken} times for FREE?` :
            `Add ${displayName} for FREE?`;
            
        if (!confirm(confirmMessage)) {
            return;
        }
        
        // Check limits even for free talents
        const existingIndex = talents.findIndex(t => 
            t.name === talentData.name && t.customisation === customisation
        );
        
        if (existingIndex !== -1) {
            const currentTimes = talents[existingIndex].timesTaken;
            const maxAllowed = parseInt(talentData.max) || 10;
            const actualTimesToAdd = Math.min(timesTaken, maxAllowed - currentTimes);
            
            if (actualTimesToAdd <= 0) {
                alert(`You already have the maximum number of ${displayName}`);
                return;
            }
        }
    }
    
    // Create talent object
    const talent = {
        name: talentData.name,
        displayName: customisation ? `${talentData.name} (${customisation})` : talentData.name,
        max: talentData.max,
        tests: talentData.tests || '',
        description: talentData.description || '',
        timesTaken: 1,  // Always start at 1, not the input value
        customisation: customisation
    };
    
    // Check if this exact talent already exists
    const existingTalentIndex = talents.findIndex(t => 
        t.name === talent.name && t.customisation === talent.customisation
    );
    
    if (existingTalentIndex !== -1) {
        // If it can be taken multiple times and we're adding more
        if (talentData.max !== "1") {
            const maxAllowed = parseInt(talentData.max) || 10;
            const currentTimes = talents[existingTalentIndex].timesTaken;
            const newTotal = Math.min(currentTimes + timesTaken, maxAllowed);
            
            if (currentTimes >= maxAllowed) {
                alert(`You already have the maximum number of ${talentData.name}`);
                return;
            }
            
            talents[existingTalentIndex].timesTaken = newTotal;
        } else {
            alert('You already have this talent');
            return;
        }
    } else {
        // For new talents that can be taken multiple times
        if (talentData.max !== "1" && timesTaken > 1) {
            talent.timesTaken = timesTaken;
        }
        talents.push(talent);
    }
    
    displayTalents();
    closeAddTalentModal();
}

window.closeAddTalentModal = function() {
    document.getElementById('add-talent-modal').style.display = 'none';
    document.getElementById('talent-select').value = '';
    document.getElementById('talent-customisation-input').value = '';
    document.getElementById('talent-times-input').value = '1';
    document.getElementById('talent-xp-override').checked = false; // Reset XP override checkbox
    document.getElementById('talent-details').style.display = 'none';
    document.getElementById('talent-customisation').style.display = 'none';
}

window.displayTalents = function() {
    const tbody = document.getElementById('talents-tbody');
    if (!tbody) return;
    
    const searchText = (document.getElementById('talents-search')?.value || '').toLowerCase();
    
    tbody.innerHTML = '';
    
    let displayedTalents = talents;
    if (searchText) {
        displayedTalents = talents.filter(t => 
            t.displayName.toLowerCase().includes(searchText) ||
            t.description.toLowerCase().includes(searchText)
        );
    }
    
    displayedTalents.sort((a, b) => a.displayName.localeCompare(b.displayName));
    
    displayedTalents.forEach((talent) => {
        const row = document.createElement('tr');
        const currentTimes = talent.timesTaken || 1;
        const cleanTalentKey = talent.displayName.replace(/\s+/g, '-').replace(/[()]/g, '').toLowerCase();
        const cost = window.getTalentCost(currentTimes - 1); // Cost for next advance
        const canTakeMore = talent.max === "No Limit" || parseInt(talent.max) > currentTimes;
        
        row.innerHTML = `
            <td class="skill-name-cell">${talent.displayName}</td>
            <td style="text-align: center;">${talent.max === "1" ? "1" : `${currentTimes}/${talent.max}`}</td>
            <td style="text-align: center;">
                ${canTakeMore ? 
                    `<button onclick="window.advanceTalent(${talents.indexOf(talent)})" style="padding: 5px 8px; font-size: 11px; background: #3e2f1f; color: #faf8f3; border: 1px solid #2a1f14; cursor: pointer;">+</button>
                     <span id="${cleanTalentKey}-cost-display" style="font-size: 10px; color: #666; margin-left: 5px;">(${cost} XP)</span>` 
                    : '<span style="color: #999;">Max</span>'
                }
            </td>
            <td style="font-size: 11px; padding: 5px;">${talent.description}</td>
            <td><button class="advance-btn" onclick="window.removeTalent(${talents.indexOf(talent)})" style="background: #d44; color: white;">×</button></td>
        `;
        tbody.appendChild(row);
    });
}

window.removeTalent = function(index) {
    if (confirm('Remove this talent?')) {
        talents.splice(index, 1);
        displayTalents();
    }
}

// Add search listener for talents
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('talents-search')?.addEventListener('input', function() {
        displayTalents();
    });
});

// WFRP Conditions Management System
window.getSeverityColor = function(severity) {
    const colors = {
        'severe': '#c41e3a',     // Red
        'moderate': '#ff8c00',   // Orange  
        'minor': '#ffd700',      // Yellow
        'positional': '#4682b4'  // Blue
    };
    return colors[severity] || '#666666';
}

window.getConditionDisplayName = function(conditionName, stacks) {
    const conditionData = wfrpConditions[conditionName];
    if (!conditionData) return conditionName;
    
    if (conditionData.stackable && stacks > 1) {
        return `${conditionName} (x${stacks})`;
    }
    return conditionName;
}

window.addCondition = function(conditionName, stacksToAdd = 1) {
    const conditionData = wfrpConditions[conditionName];
    if (!conditionData) {
        console.error('Unknown condition:', conditionName);
        return false;
    }
    
    // Find existing condition
    const existingIndex = activeConditions.findIndex(c => c.name === conditionName);
    
    if (existingIndex !== -1) {
        // Condition already exists
        if (conditionData.stackable) {
            // Add stacks to existing condition
            activeConditions[existingIndex].stacks += stacksToAdd;
        } else {
            // Non-stackable - don't add duplicate
            alert(`${conditionName} is already active and cannot stack!`);
            return false;
        }
    } else {
        // Create new condition entry
        activeConditions.push({
            name: conditionName,
            stacks: conditionData.stackable ? stacksToAdd : 1
        });
    }
    
    window.updateConditionDisplay();
    return true;
}

window.removeCondition = function(conditionName, stacksToRemove = 1) {
    const existingIndex = activeConditions.findIndex(c => c.name === conditionName);
    
    if (existingIndex === -1) {
        console.warn('Condition not found:', conditionName);
        return false;
    }
    
    const condition = activeConditions[existingIndex];
    const conditionData = wfrpConditions[conditionName];
    
    if (conditionData.stackable) {
        condition.stacks = Math.max(0, condition.stacks - stacksToRemove);
        if (condition.stacks <= 0) {
            activeConditions.splice(existingIndex, 1);
        }
    } else {
        activeConditions.splice(existingIndex, 1);
    }
    
    window.updateConditionDisplay();
    return true;
}

window.removeAllConditions = function() {
    if (activeConditions.length === 0) {
        alert('No conditions to remove!');
        return;
    }
    
    if (confirm(`Remove all ${activeConditions.length} active conditions?`)) {
        activeConditions.length = 0;
        window.updateConditionDisplay();
    }
}

window.updateConditionDisplay = function() {
    const display = document.getElementById('active-conditions-display');
    const noConditionsMsg = document.getElementById('no-conditions-message');
    const searchText = (document.getElementById('conditions-search')?.value || '').toLowerCase();
    
    // Clear current display
    display.innerHTML = '';
    
    // Filter conditions based on search
    let filteredConditions = activeConditions;
    if (searchText) {
        filteredConditions = activeConditions.filter(c => 
            c.name.toLowerCase().includes(searchText) ||
            wfrpConditions[c.name]?.description.toLowerCase().includes(searchText)
        );
    }
    
    if (filteredConditions.length === 0) {
        noConditionsMsg.style.display = 'block';
        display.style.display = 'none';
    } else {
        noConditionsMsg.style.display = 'none';
        display.style.display = 'grid';
        
        filteredConditions.forEach(condition => {
            const conditionData = wfrpConditions[condition.name];
            if (!conditionData) return;
            
            const conditionCard = document.createElement('div');
            const severityColor = window.getSeverityColor(conditionData.severity);
            const displayName = window.getConditionDisplayName(condition.name, condition.stacks);
            
            conditionCard.style.cssText = `
                background: #faf8f3;
                border: 2px solid ${severityColor};
                border-radius: 5px;
                padding: 12px;
                position: relative;
            `;
            
            conditionCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h4 style="margin: 0; color: ${severityColor}; font-size: 16px;">${displayName}</h4>
                    <button onclick="window.removeCondition('${condition.name}', ${condition.stacks})" 
                            style="background: #c41e3a; color: white; border: none; width: 20px; height: 20px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: bold;">×</button>
                </div>
                <p style="font-size: 12px; color: #333; line-height: 1.3; margin: 0 0 10px 0;">${conditionData.description}</p>
                <div style="display: flex; gap: 5px; align-items: center;">
                    ${conditionData.stackable ? 
                        `<button onclick="window.removeCondition('${condition.name}', 1)" style="width: 20px; height: 20px; background: #e8dfd0; border: 1px solid #8b7355; cursor: pointer;">−</button>
                         <span style="font-size: 12px; color: #666; min-width: 40px; text-align: center;">Stacks: ${condition.stacks}</span>
                         <button onclick="window.addCondition('${condition.name}', 1)" style="width: 20px; height: 20px; background: #e8dfd0; border: 1px solid #8b7355; cursor: pointer;">+</button>`
                        : '<span style="font-size: 12px; color: #666;">Cannot stack</span>'
                    }
                </div>
            `;
            
            display.appendChild(conditionCard);
        });
    }
    
    // Update penalty display
    window.displayConditionPenalties();
}

window.getActiveConditionPenalties = function() {
    const penalties = {
        allTests: 0,
        movementTests: 0,
        sightTests: 0,
        hearingTests: 0,
        specialEffects: []
    };
    
    activeConditions.forEach(condition => {
        const conditionData = wfrpConditions[condition.name];
        if (!conditionData) return;
        
        const stacks = condition.stacks || 1;
        const effects = conditionData.effects;
        
        // Calculate cumulative penalties
        if (effects.allTests) {
            penalties.allTests += effects.allTests * stacks;
        }
        if (effects.movementTests) {
            penalties.movementTests += effects.movementTests * stacks;
        }
        if (effects.sightTests) {
            penalties.sightTests += effects.sightTests * stacks;
        }
        if (effects.hearingTests) {
            penalties.hearingTests += effects.hearingTests * stacks;
        }
        
        // Special effects (non-stacking)
        if (effects.noActions) {
            penalties.specialEffects.push('Cannot take Actions');
        }
        if (effects.noMovement) {
            penalties.specialEffects.push('Cannot move');
        }
        if (effects.mustFlee) {
            penalties.specialEffects.push('Must flee/hide');
        }
        if (effects.incapacitated) {
            penalties.specialEffects.push('Incapacitated');
        }
        if (effects.damage) {
            const damageText = stacks > 1 && effects.damagePerStack ? 
                `${effects.damage} ${effects.damagePerStack.replace('+1', `+${stacks-1}`)}` : 
                effects.damage;
            penalties.specialEffects.push(`Damage: ${damageText}/round`);
        }
    });
    
    return penalties;
}

window.displayConditionPenalties = function() {
    const penalties = window.getActiveConditionPenalties();
    const summaryDiv = document.getElementById('condition-penalties-summary');
    const penaltyText = document.getElementById('penalty-text');
    
    const penaltyStrings = [];
    
    // Test penalties
    if (penalties.allTests !== 0) {
        penaltyStrings.push(`All Tests ${penalties.allTests >= 0 ? '+' : ''}${penalties.allTests}`);
    }
    if (penalties.movementTests !== 0) {
        penaltyStrings.push(`Movement Tests ${penalties.movementTests >= 0 ? '+' : ''}${penalties.movementTests}`);
    }
    if (penalties.sightTests !== 0) {
        penaltyStrings.push(`Sight Tests ${penalties.sightTests >= 0 ? '+' : ''}${penalties.sightTests}`);
    }
    if (penalties.hearingTests !== 0) {
        penaltyStrings.push(`Hearing Tests ${penalties.hearingTests >= 0 ? '+' : ''}${penalties.hearingTests}`);
    }
    
    // Special effects
    penalties.specialEffects.forEach(effect => penaltyStrings.push(effect));
    
    if (penaltyStrings.length > 0) {
        penaltyText.textContent = penaltyStrings.join(' • ');
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.style.display = 'none';
    }
}

window.openAddConditionModal = function() {
    window.populateConditionSelect();
    document.getElementById('add-condition-modal').style.display = 'block';
}

window.populateConditionSelect = function() {
    const select = document.getElementById('condition-select');
    select.innerHTML = '<option value="">-- Choose a condition --</option>';
    
    Object.keys(wfrpConditions).sort().forEach(conditionName => {
        const option = document.createElement('option');
        option.value = conditionName;
        option.textContent = conditionName;
        select.appendChild(option);
    });
}

window.showConditionDetails = function() {
    const select = document.getElementById('condition-select');
    const selectedCondition = select.value;
    
    if (!selectedCondition || !wfrpConditions[selectedCondition]) {
        document.getElementById('condition-details').style.display = 'none';
        document.getElementById('stacks-input-section').style.display = 'none';
        return;
    }
    
    const conditionData = wfrpConditions[selectedCondition];
    const severityColor = window.getSeverityColor(conditionData.severity);
    
    // Update details display
    document.getElementById('detail-condition-name').textContent = selectedCondition;
    document.getElementById('detail-condition-stackable').textContent = conditionData.stackable ? 'Yes' : 'No';
    document.getElementById('detail-condition-effects').textContent = conditionData.description;
    
    // Update severity badge
    const badge = document.getElementById('condition-severity-badge');
    badge.textContent = conditionData.severity.toUpperCase();
    badge.style.backgroundColor = severityColor;
    
    document.getElementById('condition-details').style.display = 'block';
    
    // Show stacks input for stackable conditions
    if (conditionData.stackable) {
        document.getElementById('stacks-input-section').style.display = 'block';
    } else {
        document.getElementById('stacks-input-section').style.display = 'none';
    }
}

window.confirmAddCondition = function() {
    const select = document.getElementById('condition-select');
    const selectedCondition = select.value;
    
    if (!selectedCondition) {
        alert('Please select a condition');
        return;
    }
    
    const conditionData = wfrpConditions[selectedCondition];
    const stacksToAdd = conditionData.stackable ? 
        parseInt(document.getElementById('condition-stacks-input').value) || 1 : 1;
    
    if (window.addCondition(selectedCondition, stacksToAdd)) {
        window.closeAddConditionModal();
    }
}

window.closeAddConditionModal = function() {
    document.getElementById('add-condition-modal').style.display = 'none';
    document.getElementById('condition-select').value = '';
    document.getElementById('condition-stacks-input').value = '1';
    document.getElementById('condition-details').style.display = 'none';
    document.getElementById('stacks-input-section').style.display = 'none';
}

// Add search listener for conditions
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('conditions-search')?.addEventListener('input', function() {
        window.updateConditionDisplay();
    });
});

// Critical Wounds Management System
let woundIdCounter = 1;

// Function to update all characteristics based on critical wound penalties
window.updateAllCharacteristicsFromWounds = function() {
    const characteristics = ['ws', 'bs', 's', 't', 'i', 'ag', 'dex', 'int', 'wp', 'fel'];
    characteristics.forEach(char => {
        const initialInput = document.getElementById(`${char}-initial`);
        if (initialInput) {
            // Trigger the input event to recalculate current value
            initialInput.dispatchEvent(new Event('input'));
        }
    });
}

// Function to get skill penalties from critical wounds
window.getSkillPenaltiesFromWounds = function(skillName) {
    let totalPenalty = 0;
    const penalties = [];
    
    criticalWounds.forEach(wound => {
        // Check permanent effects for skill penalties
        if (wound.permanentEffects) {
            wound.permanentEffects.forEach(effect => {
                // Language Tests penalties
                if (effect.includes('Language Tests') && isLanguageSkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
                // Ranged Tests penalties
                else if (effect.includes('Ranged Tests') && isRangedSkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
                // Movement Tests penalties  
                else if (effect.includes('Movement Tests') && isMovementSkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
                // Hearing Tests penalties
                else if (effect.includes('Hearing Tests') && isHearingSkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
                // Sight Tests penalties
                else if (effect.includes('Sight Tests') && isSightSkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
                // Dexterity Tests penalties
                else if (effect.includes('Dexterity Tests') && isDexteritySkill(skillName)) {
                    const penaltyMatch = effect.match(/-(\d+)/);
                    if (penaltyMatch) {
                        const penalty = parseInt(penaltyMatch[1]);
                        totalPenalty += penalty;
                        penalties.push(`${wound.name}: -${penalty}`);
                    }
                }
            });
        }
        
        // Check injury effects
        if (wound.injuries) {
            wound.injuries.forEach(injuryName => {
                const injury = injuryTypes[injuryName];
                if (injury && injury.effects[wound.location.replace(/^(Left |Right )/, '')]) {
                    const effect = injury.effects[wound.location.replace(/^(Left |Right )/, '')];
                    
                    // Check for specific skill penalties in injury effects
                    if (effect.includes('-10 to Tests using arm') && isArmBasedSkill(skillName)) {
                        totalPenalty += 10;
                        penalties.push(`${wound.name} (${injuryName}): -10`);
                    } else if (effect.includes('-20 to Tests using arm') && isArmBasedSkill(skillName)) {
                        totalPenalty += 20;
                        penalties.push(`${wound.name} (${injuryName}): -20`);
                    } else if (effect.includes('-10 to Tests using leg') && isLegBasedSkill(skillName)) {
                        totalPenalty += 10;
                        penalties.push(`${wound.name} (${injuryName}): -10`);
                    } else if (effect.includes('-20 to Tests using leg') && isLegBasedSkill(skillName)) {
                        totalPenalty += 20;
                        penalties.push(`${wound.name} (${injuryName}): -20`);
                    } else if (effect.includes('-10 to head-based Tests') && isHeadBasedSkill(skillName)) {
                        totalPenalty += 10;
                        penalties.push(`${wound.name} (${injuryName}): -10`);
                    } else if (effect.includes('-20 to head-based Tests') && isHeadBasedSkill(skillName)) {
                        totalPenalty += 20;
                        penalties.push(`${wound.name} (${injuryName}): -20`);
                    } else if (effect.includes('-10 to body-based Tests') && isBodyBasedSkill(skillName)) {
                        totalPenalty += 10;
                        penalties.push(`${wound.name} (${injuryName}): -10`);
                    } else if (effect.includes('-20 to body-based Tests') && isBodyBasedSkill(skillName)) {
                        totalPenalty += 20;
                        penalties.push(`${wound.name} (${injuryName}): -20`);
                    }
                }
            });
        }
    });
    
    return { totalPenalty, penalties };
}

// Helper functions to determine skill categories
function isLanguageSkill(skillName) {
    return skillName.includes('Language') || skillName === 'Language (Classical)' || skillName === 'Language (Guilder)';
}

function isRangedSkill(skillName) {
    return skillName === 'Ranged (Bow)' || skillName === 'Ranged (Crossbow)' || skillName === 'Ranged (Engineering)' || 
           skillName === 'Ranged (Entangling)' || skillName === 'Ranged (Explosives)' || skillName === 'Ranged (Sling)' || 
           skillName === 'Ranged (Throwing)';
}

function isMovementSkill(skillName) {
    return skillName === 'Athletics' || skillName === 'Climb' || skillName === 'Dodge' || skillName === 'Stealth';
}

function isHearingSkill(skillName) {
    return skillName === 'Perception' || skillName === 'Track';
}

function isSightSkill(skillName) {
    return skillName === 'Perception' || skillName === 'Track' || skillName === 'Art' || 
           skillName.includes('Ranged') || skillName === 'Navigation';
}

function isDexteritySkill(skillName) {
    return skillName === 'Art' || skillName === 'Sleight of Hand' || skillName === 'Pick Lock' || 
           skillName === 'Trade (any)' || skillName.includes('Trade');
}

function isArmBasedSkill(skillName) {
    return skillName.includes('Melee') || skillName.includes('Ranged') || skillName === 'Athletics' || 
           skillName === 'Art' || skillName === 'Sleight of Hand' || skillName === 'Pick Lock' || 
           skillName.includes('Trade');
}

function isLegBasedSkill(skillName) {
    return skillName === 'Athletics' || skillName === 'Climb' || skillName === 'Dodge' || 
           skillName === 'Stealth' || skillName === 'Row';
}

function isHeadBasedSkill(skillName) {
    return skillName.includes('Language') || skillName === 'Entertain (Storytelling)' || 
           skillName === 'Charm' || skillName === 'Gossip' || skillName === 'Leadership';
}

function isBodyBasedSkill(skillName) {
    return skillName === 'Endurance' || skillName === 'Swim' || skillName === 'Athletics';
}

window.getSeverityColorForWound = function(wounds) {
    if (wounds === "Death" || wounds >= 5) return '#000000'; // Fatal
    if (wounds >= 4) return '#c41e3a'; // Severe (red)
    if (wounds >= 2) return '#ff8c00'; // Moderate (orange)
    return '#ffd700'; // Minor (yellow)
}

window.addCriticalWound = function(woundData) {
    const wound = {
        id: woundIdCounter++,
        name: woundData.name || "Unknown Wound",
        location: woundData.location || "Unknown",
        wounds: woundData.wounds || 0,
        effects: woundData.effects || "",
        healingTime: woundData.healingTime || 0,
        daysHealed: woundData.daysHealed || 0,
        permanent: woundData.permanent || false,
        surgeryRequired: woundData.surgeryRequired || false,
        notes: woundData.notes || "",
        conditions: woundData.conditions || [],
        injuries: woundData.injuries || [],
        permanentEffects: woundData.permanentEffects || [],
        amputation: woundData.amputation || null,
        dateAdded: new Date().toLocaleDateString()
    };
    
    criticalWounds.push(wound);
    
    // Auto-add conditions if specified
    if (wound.conditions && wound.conditions.length > 0) {
        wound.conditions.forEach(condition => {
            window.addCondition(condition, 1);
        });
    }
    
    window.displayCriticalWounds();
    window.updateWoundPenalties();
    window.updateAllCharacteristicsFromWounds();
    // Update all skills to reflect wound penalties
    if (typeof window.updateAllSkillTotals === 'function') {
        window.updateAllSkillTotals();
    }
    return wound.id;
}

window.removeCriticalWound = function(woundId) {
    const woundIndex = criticalWounds.findIndex(w => w.id === parseInt(woundId));
    if (woundIndex === -1) {
        console.warn('Wound not found:', woundId);
        return false;
    }
    
    const wound = criticalWounds[woundIndex];
    if (confirm(`Remove critical wound "${wound.name}" from ${wound.location}?`)) {
        criticalWounds.splice(woundIndex, 1);
        window.displayCriticalWounds();
        window.updateWoundPenalties();
        window.updateAllCharacteristicsFromWounds();
        // Update all skills to reflect wound penalties
        if (typeof window.updateAllSkillTotals === 'function') {
            window.updateAllSkillTotals();
        }
        return true;
    }
    return false;
}

window.updateWoundHealing = function(woundId, daysChange) {
    const wound = criticalWounds.find(w => w.id === parseInt(woundId));
    if (!wound) {
        console.warn('Wound not found:', woundId);
        return;
    }
    
    if (wound.permanent) {
        alert('This is a permanent injury and cannot be healed through time.');
        return;
    }
    
    wound.daysHealed = Math.max(0, wound.daysHealed + daysChange);
    
    // Check if fully healed
    if (wound.daysHealed >= wound.healingTime && wound.healingTime > 0) {
        if (confirm(`"${wound.name}" appears to be fully healed (${wound.daysHealed}/${wound.healingTime} days). Remove this wound?`)) {
            window.removeCriticalWound(woundId);
            return;
        }
    }
    
    window.displayCriticalWounds();
}

window.displayCriticalWounds = function() {
    const tbody = document.getElementById('wounds-tbody');
    const noWoundsMsg = document.getElementById('no-wounds-message');
    const searchText = (document.getElementById('wounds-search')?.value || '').toLowerCase();
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let displayedWounds = criticalWounds;
    
    // Apply search filter
    if (searchText) {
        displayedWounds = displayedWounds.filter(w => 
            w.name.toLowerCase().includes(searchText) ||
            w.location.toLowerCase().includes(searchText) ||
            w.effects.toLowerCase().includes(searchText) ||
            w.notes.toLowerCase().includes(searchText)
        );
    }
    
    if (displayedWounds.length === 0) {
        noWoundsMsg.style.display = 'block';
        document.getElementById('active-wounds-display').style.display = 'none';
    } else {
        noWoundsMsg.style.display = 'none';
        document.getElementById('active-wounds-display').style.display = 'block';
        
        displayedWounds.forEach(wound => {
            const row = document.createElement('tr');
            const severityColor = window.getSeverityColorForWound(wound.wounds);
            
            // Determine healing display
            let healingDisplay = '';
            if (wound.permanent) {
                healingDisplay = '<span style="color: #8b0000; font-weight: bold;">Permanent</span>';
            } else if (wound.healingTime > 0) {
                const percentage = Math.min(100, (wound.daysHealed / wound.healingTime) * 100);
                healingDisplay = `
                    <div style="text-align: center;">
                        <div style="font-size: 12px; margin-bottom: 3px;">Day ${wound.daysHealed} of ${wound.healingTime}</div>
                        <div style="width: 100%; background: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <div style="width: ${percentage}%; background: #4CAF50; height: 100%; border-radius: 4px;"></div>
                        </div>
                        <div style="display: flex; gap: 2px; justify-content: center;">
                            <button onclick="window.updateWoundHealing(${wound.id}, -1)" style="width: 20px; height: 20px; background: #e8dfd0; border: 1px solid #8b7355; cursor: pointer; font-size: 12px;">−</button>
                            <button onclick="window.updateWoundHealing(${wound.id}, 1)" style="width: 20px; height: 20px; background: #e8dfd0; border: 1px solid #8b7355; cursor: pointer; font-size: 12px;">+</button>
                        </div>
                    </div>
                `;
            } else {
                healingDisplay = '<span style="color: #666; font-style: italic;">No healing time set</span>';
            }
            
            // Effects display with truncation
            let effectsDisplay = wound.effects;
            if (effectsDisplay.length > 100) {
                effectsDisplay = effectsDisplay.substring(0, 97) + '...';
            }
            
            row.style.borderLeft = `4px solid ${severityColor}`;
            row.innerHTML = `
                <td style="border: 1px solid #8b7355; padding: 8px; vertical-align: top;">
                    <div style="font-weight: bold; color: ${severityColor}; margin-bottom: 3px;">${wound.name}</div>
                    ${wound.surgeryRequired ? '<div style="font-size: 10px; color: #c41e3a; font-weight: bold;">⚕️ Surgery Required</div>' : ''}
                    ${wound.wounds === "Death" ? '<div style="font-size: 10px; color: #000; font-weight: bold;">💀 Fatal</div>' : `<div style="font-size: 10px; color: #666;">Wounds: ${wound.wounds}</div>`}
                </td>
                <td style="border: 1px solid #8b7355; padding: 8px; text-align: center; vertical-align: middle;">
                    <span style="font-weight: bold;">${wound.location}</span>
                </td>
                <td style="border: 1px solid #8b7355; padding: 8px; text-align: center; vertical-align: middle; min-width: 120px;">
                    ${healingDisplay}
                </td>
                <td style="border: 1px solid #8b7355; padding: 8px; vertical-align: top; max-width: 200px;">
                    <div style="font-size: 12px; line-height: 1.3;">${effectsDisplay}</div>
                    ${wound.notes ? `<div style="font-size: 11px; color: #666; margin-top: 5px; font-style: italic;">${wound.notes}</div>` : ''}
                </td>
                <td style="border: 1px solid #8b7355; padding: 8px; text-align: center; vertical-align: middle;">
                    <div style="display: flex; flex-direction: column; gap: 3px;">
                        <button onclick="window.editCriticalWound(${wound.id})" style="padding: 3px 6px; font-size: 10px; background: #4682b4; color: white; border: none; cursor: pointer; border-radius: 2px;">Edit</button>
                        ${!wound.permanent && wound.healingTime > 0 ? `<button onclick="window.markWoundHealed(${wound.id})" style="padding: 3px 6px; font-size: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 2px;">Healed</button>` : ''}
                        <button onclick="window.removeCriticalWound(${wound.id})" style="padding: 3px 6px; font-size: 10px; background: #c41e3a; color: white; border: none; cursor: pointer; border-radius: 2px;">Remove</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
}

window.markWoundHealed = function(woundId) {
    const wound = criticalWounds.find(w => w.id === parseInt(woundId));
    if (!wound) return;
    
    if (confirm(`Mark "${wound.name}" as fully healed and remove from wounds list?`)) {
        window.removeCriticalWound(woundId);
    }
}

window.editCriticalWound = function(woundId) {
    const wound = criticalWounds.find(w => w.id === parseInt(woundId));
    if (!wound) return;
    
    // Populate edit modal with current wound data
    document.getElementById('wound-name-input').value = wound.name;
    document.getElementById('wound-location-select').value = wound.location;
    document.getElementById('wound-wounds-input').value = wound.wounds === "Death" ? "" : wound.wounds;
    document.getElementById('wound-healing-time-input').value = wound.healingTime;
    document.getElementById('wound-effects-input').value = wound.effects;
    document.getElementById('wound-notes-input').value = wound.notes;
    document.getElementById('wound-permanent-checkbox').checked = wound.permanent;
    document.getElementById('wound-surgery-checkbox').checked = wound.surgeryRequired;
    
    // Store the wound ID for editing
    window.editingWoundId = woundId;
    
    // Change modal title and button text
    document.querySelector('#add-wound-modal h3').textContent = 'Edit Critical Wound';
    document.querySelector('#add-wound-modal .control-btn').textContent = 'Save Changes';
    
    window.openAddWoundModal();
}

window.getCriticalWoundPenalties = function() {
    const penalties = {
        characteristics: {},
        tests: {},
        movement: 0,
        specialEffects: []
    };
    
    criticalWounds.forEach(wound => {
        // Parse permanent effects
        if (wound.permanentEffects) {
            wound.permanentEffects.forEach(effect => {
                if (effect.includes('Intelligence')) {
                    penalties.characteristics.Int = (penalties.characteristics.Int || 0) - 10;
                } else if (effect.includes('Willpower')) {
                    penalties.characteristics.WP = (penalties.characteristics.WP || 0) - 10;
                } else if (effect.includes('Fellowship')) {
                    penalties.characteristics.Fel = (penalties.characteristics.Fel || 0) - 10;
                } else if (effect.includes('Strength')) {
                    penalties.characteristics.S = (penalties.characteristics.S || 0) - 30;
                } else if (effect.includes('Agility')) {
                    penalties.characteristics.Ag = (penalties.characteristics.Ag || 0) - 30;
                } else if (effect.includes('Dexterity Tests')) {
                    penalties.tests.Dex = (penalties.tests.Dex || 0) - 20;
                } else if (effect.includes('Ranged Tests')) {
                    penalties.tests.Ranged = (penalties.tests.Ranged || 0) - 20;
                } else if (effect.includes('Language Tests')) {
                    penalties.tests.Language = (penalties.tests.Language || 0) - 10;
                } else if (effect.includes('Movement Tests')) {
                    penalties.tests.Movement = (penalties.tests.Movement || 0) - 20;
                } else if (effect.includes('half Movement') || effect.includes('half Move')) {
                    penalties.movement = Math.max(penalties.movement, 0.5);
                } else if (effect.includes('unusable') || effect.includes('lost')) {
                    penalties.specialEffects.push(effect);
                }
            });
        }
        
        // Apply injury effects
        if (wound.injuries) {
            wound.injuries.forEach(injuryName => {
                const injury = injuryTypes[injuryName];
                if (injury && injury.effects[wound.location.replace(/^(Left |Right )/, '')]) {
                    const effect = injury.effects[wound.location.replace(/^(Left |Right )/, '')];
                    if (effect.includes('-30 Strength')) {
                        penalties.characteristics.S = (penalties.characteristics.S || 0) - 30;
                    }
                    if (effect.includes('-30 Agility')) {
                        penalties.characteristics.Ag = (penalties.characteristics.Ag || 0) - 30;
                    }
                    if (effect.includes('half Move')) {
                        penalties.movement = Math.max(penalties.movement, 0.5);
                    }
                    if (effect.includes('unusable')) {
                        penalties.specialEffects.push(`${wound.location} unusable (${injuryName})`);
                    }
                }
            });
        }
        
        // Special wound effects
        if (wound.amputation) {
            penalties.specialEffects.push(`${wound.amputation} amputated`);
        }
    });
    
    return penalties;
}

window.updateWoundPenalties = function() {
    const penalties = window.getCriticalWoundPenalties();
    const summaryDiv = document.getElementById('wound-penalties-summary');
    const penaltyText = document.getElementById('wound-penalty-text');
    
    const penaltyStrings = [];
    
    // Characteristic penalties
    Object.keys(penalties.characteristics).forEach(char => {
        const penalty = penalties.characteristics[char];
        if (penalty !== 0) {
            penaltyStrings.push(`${char} ${penalty >= 0 ? '+' : ''}${penalty}`);
        }
    });
    
    // Test penalties
    Object.keys(penalties.tests).forEach(testType => {
        const penalty = penalties.tests[testType];
        if (penalty !== 0) {
            penaltyStrings.push(`${testType} Tests ${penalty >= 0 ? '+' : ''}${penalty}`);
        }
    });
    
    // Movement penalties
    if (penalties.movement > 0) {
        if (penalties.movement === 0.5) {
            penaltyStrings.push('Movement halved');
        } else {
            penaltyStrings.push(`Movement -${penalties.movement}`);
        }
    }
    
    // Special effects
    penalties.specialEffects.forEach(effect => penaltyStrings.push(effect));
    
    if (penaltyStrings.length > 0) {
        penaltyText.textContent = penaltyStrings.join(' • ');
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.style.display = 'none';
    }
}

window.removeAllWounds = function() {
    if (criticalWounds.length === 0) {
        alert('No critical wounds to remove!');
        return;
    }
    
    if (confirm(`Remove all ${criticalWounds.length} critical wounds?`)) {
        criticalWounds.length = 0;
        window.displayCriticalWounds();
        window.updateWoundPenalties();
        window.updateAllCharacteristicsFromWounds();
        // Update all skills to reflect wound penalties
        if (typeof window.updateAllSkillTotals === 'function') {
            window.updateAllSkillTotals();
        }
    }
}

window.openAddWoundModal = function() {
    // Reset form if not editing
    if (!window.editingWoundId) {
        document.getElementById('wound-name-input').value = '';
        document.getElementById('wound-location-select').value = '';
        document.getElementById('wound-wounds-input').value = '';
        document.getElementById('wound-healing-time-input').value = '';
        document.getElementById('wound-effects-input').value = '';
        document.getElementById('wound-notes-input').value = '';
        document.getElementById('wound-permanent-checkbox').checked = false;
        document.getElementById('wound-surgery-checkbox').checked = false;
        
        // Reset modal title and button
        document.querySelector('#add-wound-modal h3').textContent = 'Add Critical Wound';
        document.querySelector('#add-wound-modal .control-btn').textContent = 'Add Wound';
    }
    
    document.getElementById('add-wound-modal').style.display = 'block';
}

window.closeAddWoundModal = function() {
    document.getElementById('add-wound-modal').style.display = 'none';
    window.editingWoundId = null;
}

window.confirmAddWound = function() {
    const name = document.getElementById('wound-name-input').value.trim();
    const location = document.getElementById('wound-location-select').value;
    const wounds = document.getElementById('wound-wounds-input').value;
    const healingTime = parseInt(document.getElementById('wound-healing-time-input').value) || 0;
    const effects = document.getElementById('wound-effects-input').value.trim();
    const notes = document.getElementById('wound-notes-input').value.trim();
    const permanent = document.getElementById('wound-permanent-checkbox').checked;
    const surgeryRequired = document.getElementById('wound-surgery-checkbox').checked;
    
    if (!name) {
        alert('Please enter a wound name');
        return;
    }
    
    if (!location) {
        alert('Please select a location');
        return;
    }
    
    const woundData = {
        name: name,
        location: location,
        wounds: wounds || 0,
        healingTime: permanent ? 0 : healingTime,
        effects: effects,
        notes: notes,
        permanent: permanent,
        surgeryRequired: surgeryRequired,
        daysHealed: 0
    };
    
    if (window.editingWoundId) {
        // Edit existing wound
        const wound = criticalWounds.find(w => w.id === parseInt(window.editingWoundId));
        if (wound) {
            Object.assign(wound, woundData);
            window.displayCriticalWounds();
            window.updateWoundPenalties();
            window.updateAllCharacteristicsFromWounds();
            // Update all skills to reflect wound penalties
            if (typeof window.updateAllSkillTotals === 'function') {
                window.updateAllSkillTotals();
            }
        }
        window.editingWoundId = null;
    } else {
        // Add new wound
        window.addCriticalWound(woundData);
    }
    
    window.closeAddWoundModal();
}

// Reference Modal Functions
window.openWoundReferenceModal = function() {
    document.getElementById('wound-reference-modal').style.display = 'block';
    window.showWoundLocation('Head'); // Default to Head tab
}

window.closeWoundReferenceModal = function() {
    document.getElementById('wound-reference-modal').style.display = 'none';
}

window.showWoundLocation = function(location) {
    // Update tab appearance
    ['Head', 'Arm', 'Body', 'Leg'].forEach(loc => {
        const tab = document.getElementById(`wound-tab-${loc}`);
        if (loc === location) {
            tab.style.background = '#e8dfd0';
            tab.style.color = '#3e2f1f';
            tab.style.fontWeight = 'bold';
        } else {
            tab.style.background = '#f5f5f0';
            tab.style.color = '#666';
            tab.style.fontWeight = 'normal';
        }
    });
    
    // Filter wounds by location
    const searchText = (document.getElementById('wound-reference-search')?.value || '').toLowerCase();
    const content = document.getElementById('wound-reference-content');
    
    let filteredWounds = Object.entries(wfrpCriticalWounds).filter(([key, wound]) => 
        wound.location === location
    );
    
    // Apply search filter
    if (searchText) {
        filteredWounds = filteredWounds.filter(([key, wound]) =>
            wound.name.toLowerCase().includes(searchText) ||
            wound.effects.toLowerCase().includes(searchText)
        );
    }
    
    content.innerHTML = '';
    
    if (filteredWounds.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No wounds found matching your search.</div>';
        return;
    }
    
    // Create wounds table
    const table = document.createElement('table');
    table.style.cssText = 'width: 100%; border-collapse: collapse; background: #faf8f3; border: 2px solid #8b7355;';
    
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr style="background: #e8dfd0; color: #3e2f1f; font-weight: bold;">
            <th style="border: 1px solid #8b7355; padding: 8px; text-align: left;">Wound Name</th>
            <th style="border: 1px solid #8b7355; padding: 8px; text-align: center;">Wounds</th>
            <th style="border: 1px solid #8b7355; padding: 8px; text-align: left;">Effects</th>
            <th style="border: 1px solid #8b7355; padding: 8px; text-align: center;">Add</th>
        </tr>
    `;
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    
    filteredWounds.forEach(([key, wound]) => {
        const row = document.createElement('tr');
        const severityColor = window.getSeverityColorForWound(wound.wounds);
        
        row.style.borderLeft = `4px solid ${severityColor}`;
        row.innerHTML = `
            <td style="border: 1px solid #8b7355; padding: 8px; vertical-align: top;">
                <div style="font-weight: bold; color: ${severityColor};">${wound.name}</div>
                <div style="font-size: 10px; color: #666; text-transform: uppercase;">${wound.severity}</div>
            </td>
            <td style="border: 1px solid #8b7355; padding: 8px; text-align: center; vertical-align: middle; font-weight: bold;">
                ${wound.wounds}
            </td>
            <td style="border: 1px solid #8b7355; padding: 8px; vertical-align: top; font-size: 12px; line-height: 1.3;">
                ${wound.effects}
            </td>
            <td style="border: 1px solid #8b7355; padding: 8px; text-align: center; vertical-align: middle;">
                <button onclick="window.selectReferenceWound('${key}')" style="padding: 4px 8px; font-size: 10px; background: #4682b4; color: white; border: none; cursor: pointer; border-radius: 2px;">Add This</button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    content.appendChild(table);
}

window.selectReferenceWound = function(woundKey) {
    const wound = wfrpCriticalWounds[woundKey];
    if (!wound) return;
    
    // Close reference modal
    window.closeWoundReferenceModal();
    
    // Create wound data with defaults
    const woundData = {
        name: wound.name,
        location: wound.location === 'Arm' ? 'Right Arm' : wound.location === 'Leg' ? 'Right Leg' : wound.location,
        wounds: wound.wounds,
        effects: wound.effects,
        healingTime: wound.wounds === "Death" ? 0 : (wound.wounds >= 4 ? 30 : wound.wounds >= 2 ? 14 : 7),
        permanent: wound.severity === 'fatal' && wound.wounds !== "Death",
        surgeryRequired: wound.surgeryRequired || false,
        conditions: wound.conditions || [],
        injuries: wound.injuries || [],
        permanentEffects: wound.permanentEffects || [],
        amputation: wound.amputation || null,
        notes: `From WFRP reference (${wound.severity})`
    };
    
    // Add the wound
    const woundId = window.addCriticalWound(woundData);
    
    // Show success message
    alert(`Added "${wound.name}" to ${woundData.location}. ${wound.conditions ? `Applied ${wound.conditions.length} condition(s).` : ''}`);
}

// Add search listener for wounds
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('wounds-search')?.addEventListener('input', function() {
        window.displayCriticalWounds();
    });
    
    document.getElementById('wound-reference-search')?.addEventListener('input', function() {
        // Re-show current location with new search
        const activeTab = document.querySelector('[id^="wound-tab-"][style*="background: rgb(232, 223, 208)"]');
        if (activeTab) {
            const location = activeTab.id.replace('wound-tab-', '');
            window.showWoundLocation(location);
        }
    });
});

// Spells & Prayers Management Functions
window.displaySpells = function() {
    const tbody = document.getElementById('spells-tbody');
    if (!tbody) return;
    
    const searchText = (document.getElementById('spells-search')?.value || '').toLowerCase();
    const filterType = document.getElementById('spells-filter')?.value || 'all';
    
    tbody.innerHTML = '';
    
    let displayedSpells = spells;
    
    // Apply search filter
    if (searchText) {
        displayedSpells = displayedSpells.filter(s => 
            s.name.toLowerCase().includes(searchText) ||
            s.lore.toLowerCase().includes(searchText) ||
            s.effect.toLowerCase().includes(searchText) ||
            (s.ingredients && s.ingredients.toLowerCase().includes(searchText))
        );
    }
    
    // Apply type filter
    if (filterType !== 'all') {
        if (filterType === 'memorised') {
            displayedSpells = displayedSpells.filter(s => s.memorised);
        } else {
            displayedSpells = displayedSpells.filter(s => s.type === filterType);
        }
    }
    
    displayedSpells.sort((a, b) => a.name.localeCompare(b.name));
    
    displayedSpells.forEach((spell, index) => {
        const row = document.createElement('tr');
        const effectPreview = spell.effect.length > 80 ? 
            spell.effect.substring(0, 80) + '...' : 
            spell.effect;
        
        const loreColor = getLoreColor(spell.lore);
        const memIcon = spell.memorised ? '✓' : '—';
        const memStyle = spell.memorised ? 'color: #2a8a2a; font-weight: bold;' : 'color: #666;';
        
        row.innerHTML = `
            <td class="skill-name-cell" style="border-left: 3px solid ${loreColor};">
                ${spell.name}
                <div style="font-size: 10px; color: #666; font-style: italic;">${spell.lore}</div>
            </td>
            <td style="text-align: center; font-weight: bold;">${spell.cn}</td>
            <td style="font-size: 11px; padding: 5px;">${spell.range}</td>
            <td style="font-size: 11px; padding: 5px;">${spell.target}</td>
            <td style="font-size: 11px; padding: 5px;">${spell.duration}</td>
            <td style="font-size: 11px; padding: 5px;">${effectPreview}</td>
            <td style="text-align: center; ${memStyle}">${memIcon}</td>
            <td><button class="advance-btn" onclick="window.removeSpell(${spells.indexOf(spell)})" style="background: #d44; color: white;">×</button></td>
        `;
        tbody.appendChild(row);
    });
}

window.getLoreColor = function(lore) {
    const colors = {
        'Fire': '#d44444',
        'Metal': '#888888',
        'Life': '#44d444', 
        'Light': '#ffd700',
        'Heavens': '#4444d4',
        'Shadow': '#444444',
        'Death': '#8B4B8B',
        'Beasts': '#8B6914',
        'Daemonology': '#8B0000',
        'Petty Magic': '#666666',
        'Sigmar': '#ffd700',
        'Ulric': '#87ceeb',
        'Morr': '#696969',
        'Verena': '#4169e1',
        'Shallya': '#f0f8ff',
        'Myrmidia': '#ffa500',
        'Ranald': '#32cd32',
        'Taal': '#228b22',
        'Rhya': '#9acd32',
        'Manann': '#00ced1'
    };
    return colors[lore] || '#8b7355';
}

window.removeSpell = function(index) {
    if (confirm('Remove this spell/prayer?')) {
        spells.splice(index, 1);
        displaySpells();
    }
}

window.addSpell = function() {
    document.getElementById('add-spell-modal').style.display = 'block';
    document.getElementById('spell-name-input').focus();
    updateLoreOptions(); // Set initial lore options
}

window.updateLoreOptions = function() {
    const type = document.getElementById('spell-type-input').value;
    const loreSelect = document.getElementById('spell-lore-input');
    
    loreSelect.innerHTML = '';
    
    if (type === 'arcane') {
        const arcaneOptions = [
            { value: '', text: 'Select Lore...' },
            { value: 'Petty Magic', text: 'Petty Magic' },
            { value: 'Fire', text: 'Fire' },
            { value: 'Metal', text: 'Metal' },
            { value: 'Life', text: 'Life' },
            { value: 'Light', text: 'Light' },
            { value: 'Heavens', text: 'Heavens' },
            { value: 'Shadow', text: 'Shadow' },
            { value: 'Death', text: 'Death' },
            { value: 'Beasts', text: 'Beasts' },
            { value: 'Daemonology', text: 'Daemonology' }
        ];
        arcaneOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            loreSelect.appendChild(option);
        });
    } else {
        const divineOptions = [
            { value: '', text: 'Select Deity...' },
            { value: 'Sigmar', text: 'Sigmar' },
            { value: 'Ulric', text: 'Ulric' },
            { value: 'Morr', text: 'Morr' },
            { value: 'Verena', text: 'Verena' },
            { value: 'Shallya', text: 'Shallya' },
            { value: 'Myrmidia', text: 'Myrmidia' },
            { value: 'Ranald', text: 'Ranald' },
            { value: 'Taal', text: 'Taal' },
            { value: 'Rhya', text: 'Rhya' },
            { value: 'Manann', text: 'Manann' }
        ];
        divineOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            loreSelect.appendChild(option);
        });
    }
}

window.confirmAddSpell = function() {
    const source = document.getElementById('spell-source-input').value;
    const memorised = document.getElementById('spell-memorised-input').checked;
    let spell;
    
    if (source === 'srd') {
        // Handle SRD spell selection
        const select = document.getElementById('srd-spell-select');
        const selectedOption = select.options[select.selectedIndex];
        
        if (!selectedOption) {
            alert('Please select a spell from the SRD list');
            return;
        }
        
        const srdSpell = JSON.parse(selectedOption.dataset.spell);
        
        // Check if spell already exists
        const exists = spells.some(s => s.name.toLowerCase() === srdSpell.name.toLowerCase());
        if (exists) {
            alert('A spell with this name already exists');
            return;
        }
        
        // Determine type based on lore
        const arcaneLores = ['Petty Magic', 'Fire', 'Metal', 'Life', 'Light', 'Heavens', 'Shadow', 'Death', 'Beasts', 'Daemonology'];
        const type = arcaneLores.includes(srdSpell.lore) ? 'arcane' : 'divine';
        
        spell = {
            name: srdSpell.name,
            type: type,
            lore: srdSpell.lore,
            cn: srdSpell.castingNumber,
            range: srdSpell.range,
            target: srdSpell.target.toString(),
            duration: srdSpell.duration,
            effect: `${srdSpell.name} (${srdSpell.lore} spell)`, // Placeholder since SRD doesn't include full effects
            ingredients: '',
            memorised: memorised
        };
    } else {
        // Handle custom spell entry
        const name = document.getElementById('spell-name-input').value.trim();
        const type = document.getElementById('spell-type-input').value;
        const lore = document.getElementById('spell-lore-input').value;
        const cn = document.getElementById('spell-cn-input').value;
        const range = document.getElementById('spell-range-input').value.trim();
        const target = document.getElementById('spell-target-input').value.trim();
        const duration = document.getElementById('spell-duration-input').value.trim();
        const effect = document.getElementById('spell-effect-input').value.trim();
        const ingredients = document.getElementById('spell-ingredients-input').value.trim();
        
        if (!name) {
            alert('Please enter a spell/prayer name');
            return;
        }
        
        if (!lore) {
            alert('Please select a lore or deity');
            return;
        }
        
        if (!cn || cn < 0) {
            alert('Please enter a valid Casting Number');
            return;
        }
        
        if (!effect) {
            alert('Please describe the spell effect');
            return;
        }
        
        // Check if spell already exists
        const exists = spells.some(s => s.name.toLowerCase() === name.toLowerCase());
        if (exists) {
            alert('A spell with this name already exists');
            return;
        }
        
        spell = {
            name: name,
            type: type,
            lore: lore,
            cn: parseInt(cn),
            range: range || 'Touch',
            target: target || '1 target',
            duration: duration || 'Instant',
            effect: effect,
            ingredients: ingredients || '',
            memorised: memorised
        };
    }
    
    spells.push(spell);
    displaySpells();
    closeAddSpellModal();
}

window.closeAddSpellModal = function() {
    document.getElementById('add-spell-modal').style.display = 'none';
    document.getElementById('spell-source-input').value = 'custom';
    document.getElementById('spell-name-input').value = '';
    document.getElementById('spell-type-input').value = 'arcane';
    document.getElementById('spell-lore-input').value = '';
    document.getElementById('spell-cn-input').value = '';
    document.getElementById('spell-range-input').value = '';
    document.getElementById('spell-target-input').value = '';
    document.getElementById('spell-duration-input').value = '';
    document.getElementById('spell-effect-input').value = '';
    document.getElementById('spell-ingredients-input').value = '';
    document.getElementById('spell-memorised-input').checked = false;
    document.getElementById('srd-spell-search').value = '';
    document.getElementById('srd-spell-select').value = '';
    document.getElementById('srd-spell-details').style.display = 'none';
    toggleSpellSource(); // Reset to custom view
}

// SRD Spell Selection Functions
window.toggleSpellSource = function() {
    const source = document.getElementById('spell-source-input').value;
    const customSection = document.getElementById('custom-spell-section');
    const srdSection = document.getElementById('srd-spell-section');
    
    if (source === 'srd') {
        customSection.style.display = 'none';
        srdSection.style.display = 'block';
        populateSRDSpellSelect();
    } else {
        customSection.style.display = 'block';
        srdSection.style.display = 'none';
    }
}

window.populateSRDSpellSelect = function() {
    const select = document.getElementById('srd-spell-select');
    select.innerHTML = '';
    
    const sortedSpells = [...srdSpells].sort((a, b) => a.name.localeCompare(b.name));
    
    sortedSpells.forEach(spell => {
        const option = document.createElement('option');
        option.value = spell.name;
        option.textContent = `${spell.name} (${spell.lore}) - CN ${spell.castingNumber}`;
        option.dataset.spell = JSON.stringify(spell);
        select.appendChild(option);
    });
}

window.filterSRDSpells = function() {
    const searchText = document.getElementById('srd-spell-search').value.toLowerCase();
    const select = document.getElementById('srd-spell-select');
    const options = select.options;
    
    let matchCount = 0;
    let firstMatch = null;
    
    for (let i = 0; i < options.length; i++) {
        try {
            const spell = JSON.parse(options[i].dataset.spell);
            const matches = searchText === '' || 
                           (spell.name && spell.name.toLowerCase().includes(searchText)) ||
                           (spell.lore && spell.lore.toLowerCase().includes(searchText));
            
            options[i].style.display = matches ? '' : 'none';
            
            if (matches) {
                matchCount++;
                if (!firstMatch) {
                    firstMatch = options[i];
                }
            }
        } catch (e) {
            console.error('Error parsing spell data for option', i, ':', e);
            options[i].style.display = 'none';
        }
    }
    
    // Select first match if any
    if (firstMatch && matchCount > 0) {
        firstMatch.selected = true;
        window.showSRDSpellDetails();
    }
}

window.showSRDSpellDetails = function() {
    const select = document.getElementById('srd-spell-select');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption) return;
    
    const spell = JSON.parse(selectedOption.dataset.spell);
    const detailsDiv = document.getElementById('srd-spell-details');
    
    document.getElementById('srd-detail-name').textContent = spell.name;
    document.getElementById('srd-detail-lore').textContent = spell.lore;
    document.getElementById('srd-detail-cn').textContent = spell.castingNumber;
    document.getElementById('srd-detail-range').textContent = spell.range;
    document.getElementById('srd-detail-target').textContent = spell.target;
    document.getElementById('srd-detail-duration').textContent = spell.duration;
    
    detailsDiv.style.display = 'block';
}

// Add search and filter listeners for spells
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('spells-search')?.addEventListener('input', function() {
        displaySpells();
    });
    
    document.getElementById('spells-filter')?.addEventListener('change', function() {
        displaySpells();
    });
});

        window.removeSkill = function(skillKey) {
            if (confirm('Are you sure you want to remove this skill?')) {
                // Remove from added skills
                addedSkills = addedSkills.filter(s => s.key !== skillKey);
                
                // Remove skill data
                delete characterSkills[skillKey];
                
                displaySkills();
            }
        }

        window.closeAddSkillModal = function() {
            document.getElementById('add-skill-modal').style.display = 'none';
            document.getElementById('skill-select').value = '';
            document.getElementById('specialisation-input').value = '';
            document.getElementById('specialisation-field').style.display = 'none';
        }

        // Filter functionality
        document.getElementById('skills-filter').addEventListener('change', function() {
            displaySkills();
        });

        // Generic function to modify values with + and - buttons (global scope)
        window.modifyValue = function(elementId, amount) {
            const element = document.getElementById(elementId);
            let newVal = (parseInt(element.value) || 0) + amount;
            newVal = Math.max(0, newVal);
            element.value = newVal;
        }

        // Save/Load functionality
        window.saveCharacter = function() {
            const characterData = {
                name: document.getElementById('character-name').value,
                species: document.getElementById('species').value,
                class: document.getElementById('class').value,
                career: document.getElementById('career').value,
                characteristics: {},
                wounds: {
                    current: document.getElementById('wounds-current').value,
                    max: document.getElementById('wounds-max').value
                },
                hardy: document.getElementById('hardy').value,
                corruption: {
                    current: document.getElementById('corruption-current').value,
                    max: document.getElementById('corruption-max').value
                },
                movement: document.getElementById('movement').value,
                fate: document.getElementById('fate').value,
                fortune: document.getElementById('fortune-current').value,
                resilience: document.getElementById('resilience').value,
                resolve: document.getElementById('resolve-current').value,
                motivation: document.getElementById('motivation').value,
                experience: {
                    total: document.getElementById('xp-total').value,
                    spent: document.getElementById('xp-spent').value
                },
                status: {
                    tier: document.getElementById('status-tier').value,
                    standing: document.getElementById('status-standing').value
                },
                sinPoints: document.getElementById('sin-points').value,
                notes: document.getElementById('quick-notes').value,
                skills: characterSkills,
                addedSkills: addedSkills,
                // New combat & equipment data
                weapons: weapons,
                armour: armour,
                trappings: trappings,
                consumables: consumables,
                talents: talents,
                activeConditions: activeConditions,
                criticalWounds: criticalWounds,
                spells: spells,
                money: {
                    gold: document.getElementById('money-gold').value,
                    silver: document.getElementById('money-silver').value,
                    brass: document.getElementById('money-brass').value
                }
            };
            
            // Save characteristics
            characteristics.forEach(char => {
                characterData.characteristics[char] = {
                    initial: document.getElementById(`${char}-initial`).value,
                    advances: document.getElementById(`${char}-advances`).value
                };
            });
            
            localStorage.setItem('wfrpCharacter', JSON.stringify(characterData));
            alert('Character saved!');
        }

        window.loadCharacter = function() {
            const savedData = localStorage.getItem('wfrpCharacter');
            if (!savedData) {
                alert('No saved character found!');
                return;
            }
            
            const characterData = JSON.parse(savedData);
            
            // Load basic info
            document.getElementById('character-name').value = characterData.name || '';
            document.getElementById('species').value = characterData.species || '';
            document.getElementById('class').value = characterData.class || '';
            document.getElementById('career').value = characterData.career || '';
            
            // Load characteristics
            if (characterData.characteristics) {
                characteristics.forEach(char => {
                    if (characterData.characteristics[char]) {
                        document.getElementById(`${char}-initial`).value = characterData.characteristics[char].initial || '';
                        document.getElementById(`${char}-advances`).value = characterData.characteristics[char].advances || '';
                        // Trigger update
                        document.getElementById(`${char}-initial`).dispatchEvent(new Event('input'));
                    }
                });
            }
            
            // Load other stats
            if (characterData.wounds) {
                document.getElementById('wounds-current').value = characterData.wounds.current || '';
                document.getElementById('wounds-max').value = characterData.wounds.max || '';
            }
            
            document.getElementById('hardy').value = characterData.hardy || '';
            
            if (characterData.corruption) {
                document.getElementById('corruption-current').value = characterData.corruption.current || '';
                document.getElementById('corruption-max').value = characterData.corruption.max || '';
            }
            
            document.getElementById('movement').value = characterData.movement || '';
            movement.dispatchEvent(new Event('input'));
            
            if (characterData.experience) {
                // Handle legacy data format (current + spent = total)
                if (characterData.experience.current !== undefined && characterData.experience.total === undefined) {
                    const current = parseInt(characterData.experience.current) || 0;
                    const spent = parseInt(characterData.experience.spent) || 0;
                    document.getElementById('xp-total').value = current + spent;
                    document.getElementById('xp-spent').value = spent;
                } else {
                    // New format (total - spent = current)
                    document.getElementById('xp-total').value = characterData.experience.total || '0';
                    document.getElementById('xp-spent').value = characterData.experience.spent || '0';
                }
                window.updateXPDisplay();
            }
            
            document.getElementById('fate').value = characterData.fate || '';
            document.getElementById('fortune-current').value = characterData.fortune || '';
            document.getElementById('resilience').value = characterData.resilience || '';
            document.getElementById('resolve-current').value = characterData.resolve || '';
            document.getElementById('motivation').value = characterData.motivation || '';
            
            // Update the max displays after loading data
            window.updateFateFortuneResilienceResolveDisplay();
            
            if (characterData.status) {
                document.getElementById('status-tier').value = characterData.status.tier || 'Brass';
                document.getElementById('status-standing').value = characterData.status.standing || '';
            }
            
            document.getElementById('sin-points').value = characterData.sinPoints || '';
            document.getElementById('quick-notes').value = characterData.notes || '';
            
            // Load skills
            if (characterData.skills) {
                characterSkills = characterData.skills;
            }
            
            // Load added skills
            if (characterData.addedSkills) {
                addedSkills = characterData.addedSkills;
            }
            if (characterData.talents) {
                talents = characterData.talents;
            }
            
            // Load active conditions
            if (characterData.activeConditions) {
                activeConditions = characterData.activeConditions;
            }
            
            // Load critical wounds
            if (characterData.criticalWounds) {
                criticalWounds = characterData.criticalWounds;
                // Update wound counter to prevent ID conflicts
                if (criticalWounds.length > 0) {
                    woundIdCounter = Math.max(...criticalWounds.map(w => w.id)) + 1;
                }
            }
            
            // Load spells
            if (characterData.spells) {
                spells = characterData.spells;
            }
            
            // Load combat & equipment data
            if (characterData.weapons) weapons = characterData.weapons;
            if (characterData.armour) armour = characterData.armour;
            if (characterData.trappings) trappings = characterData.trappings;
            if (characterData.consumables) consumables = characterData.consumables;
            
            if (characterData.money) {
                document.getElementById('money-gold').value = characterData.money.gold || '0';
                document.getElementById('money-silver').value = characterData.money.silver || '0';
                document.getElementById('money-brass').value = characterData.money.brass || '0';
            }
            
            // Refresh all displays
            displaySkills();
            displayTalents();
            window.updateConditionDisplay();
            window.displayCriticalWounds();
            window.updateWoundPenalties();
            window.updateAllCharacteristicsFromWounds();
            // Update all skills to reflect wound penalties after characteristics are updated
            setTimeout(() => {
                if (typeof window.updateAllSkillTotals === 'function') {
                    window.updateAllSkillTotals();
                }
            }, 50);
            displaySpells();
            displayWeapons();
            displayArmour();
            displayTrappings();
            displayConsumables();
            updateTotalAP();
            
            // Update encumbrance after everything is loaded
            setTimeout(() => {
                updateEncumbrance();
            }, 100);
            
            alert('Character loaded!');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Initialize XP system variables
            xpTotal = document.getElementById('xp-total');
            xpSpent = document.getElementById('xp-spent');
            window.updateXPDisplay();
            
            // Initialize Fate/Fortune/Resilience/Resolve system
            previousFate = parseInt(document.getElementById('fate').value) || 0;
            previousResilience = parseInt(document.getElementById('resilience').value) || 0;
            window.updateFateFortuneResilienceResolveDisplay();
            
            // Load SRD data
            loadSRDData();
            loadTalentsData();
            loadConditionsData();
            loadSpellsData();
            
            try {
                displaySkills(); // Show basic skills immediately
                displayTalents();
                window.updateConditionDisplay();
                window.displayCriticalWounds();
                displaySpells();
                displayWeapons();
                displayArmour();
                displayTrappings();
                displayConsumables();
                
                // Set up initial encumbrance calculation after a short delay to ensure values are loaded
                setTimeout(() => {
                    updateEncumbrance();
                    // Trigger initial characteristic updates
                    characteristics.forEach(char => {
                        const current = document.getElementById(`${char}-current`);
                        if (current && current.updateFunction) {
                            current.updateFunction();
                        }
                    });
                }, 100);
                
                console.log('Initialization complete');
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });

        // SRD Data Loading
function loadSRDData() {
    // Load weapons data
    fetch('Weapons.json')
        .then(response => response.json())
        .then(data => {
            srdWeapons = data;
            console.log('Loaded', srdWeapons.length, 'weapons from SRD');
        })
        .catch(error => {
            console.error('Error loading weapons:', error);
            // Fallback to embedded data if file not found
            loadEmbeddedSRDData();
        });
    
    // Load armour data
    fetch('Armour.json')
        .then(response => response.json())
        .then(data => {
            srdArmour = data;
            console.log('Loaded', srdArmour.length, 'armour pieces from SRD');
        })
        .catch(error => {
            console.error('Error loading armour:', error);
            // Fallback to embedded data if file not found
            loadEmbeddedSRDData();
        });
    
    // Load ammunition data
    fetch('Ammunition.json')
        .then(response => response.json())
        .then(data => {
            srdAmmunition = data;
            console.log('Loaded', srdAmmunition.length, 'ammunition types from SRD');
        })
        .catch(error => {
            console.error('Error loading ammunition:', error);
            // Use embedded data as fallback
        });
}

// Load Talents Data - This should be OUTSIDE loadSRDData
function loadTalentsData() {
    fetch('Talents.json')
        .then(response => response.json())
        .then(data => {
            srdTalents = data;
            console.log('Loaded', srdTalents.length, 'talents from SRD');
        })
        .catch(error => {
            console.error('Error loading talents:', error);
            // Minimal fallback data
            srdTalents = [
                { name: "Hardy", max: "Toughness Bonus", tests: "", description: "You gain +1 Wound permanently per level in this Talent.", customisable: false },
                { name: "Lightning Reflexes", max: "1", tests: "", description: "+5 to Initiative permanently.", customisable: false },
                { name: "Marksman", max: "1", tests: "Ranged", description: "You gain a permanent +5 BS.", customisable: false }
            ];
        });
}

// Load Conditions Data
function loadConditionsData() {
    fetch('conditions.json')
        .then(response => response.json())
        .then(data => {
            srdConditions = data;
            console.log('Loaded', srdConditions.length, 'conditions from SRD');
        })
        .catch(error => {
            console.error('Error loading conditions:', error);
            // Complete fallback data
            srdConditions = [
                { name: "Ablaze", stackable: "Yes", effects: "You are on fire! At the end of every Round, you suffer 1d10 Wounds, modified by Toughness Bonus and the Armour Points on the least protected Hit Location, with a minimum of 1 Wound suffered. Each extra Ablaze Condition you have adds +1 to the Damage suffered." },
                { name: "Bleeding", stackable: "Yes", effects: "You are bleeding badly. Lose 1 Wound at the end of every Round, ignoring all modifiers. Additionally, suffer a penalty of –10 to any Tests to resist Festering Wounds, Minor Infection, or Blood Rot." },
                { name: "Blinded", stackable: "No", effects: "You cannot see. You automatically fail all Tests that rely on vision, and any other Tests are taken with a –30 penalty. You cannot perform ranged attacks beyond Point Blank range." },
                { name: "Broken", stackable: "No", effects: "Your spirit is broken. You automatically fail Psychology Tests and gain 1 Broken Condition whenever you fail a Psychology Test. You also suffer a –10 penalty to Willpower Tests and Weapon Skill Tests." },
                { name: "Deafened", stackable: "No", effects: "You cannot hear. You automatically fail all Tests that rely on hearing, and any other Tests involving communication or concentration suffer a –10 penalty." },
                { name: "Entangled", stackable: "Yes", effects: "You have been caught or snared, and cannot move freely. Whilst entangled, you are considered to be Stationary and cannot leave your current location. You may only take a single Move or Action during your turn, not both." },
                { name: "Fatigued", stackable: "Yes", effects: "You are exhausted or stressed, and certainly in need of rest. You suffer a –10 penalty to all Tests. Removing a Fatigued Condition normally requires rest, a spell, or a divine effect." },
                { name: "Poisoned", stackable: "Yes", effects: "You have been poisoned. The exact effects of the poison will be described in the creature, spell, or item that caused this Condition. Generally, Poisoned Conditions are removed by time or appropriate medical attention." },
                { name: "Prone", stackable: "No", effects: "You have been knocked to the ground. You suffer a –20 penalty to Weapon Skill Tests when in combat, and anyone making melee attacks against you gains a +20 bonus to hit." },
                { name: "Stunned", stackable: "Yes", effects: "You have been struck about the head or otherwise disorientated or confused. You are incapable of taking an Action on your turn but are capable of half your normal movement. You also suffer a –10 penalty to all Tests." },
                { name: "Surprised", stackable: "No", effects: "You have been caught off guard. You may not take an Action on your turn, though you may still Oppose any Tests made against you. This Condition is automatically removed at the end of your Turn." },
                { name: "Unconscious", stackable: "No", effects: "You have been knocked out. You automatically fail all Tests and become unaware of your surroundings. Whilst unconscious, you are considered to be Prone." }
            ];
            console.log('Using fallback conditions data:', srdConditions.length, 'conditions loaded');
        });
}

// Load Spells Data
function loadSpellsData() {
    fetch('Spells.json')
        .then(response => response.json())
        .then(data => {
            srdSpells = data;
            console.log('Loaded', srdSpells.length, 'spells from SRD');
        })
        .catch(error => {
            console.error('Error loading spells:', error);
            // Fallback data with common WFRP spells
            srdSpells = [
                { name: "Dart", lore: "Petty Magic", castingNumber: 3, range: "12 yards", target: "1", duration: "Instant" },
                { name: "Light", lore: "Petty Magic", castingNumber: 2, range: "Touch", target: "1", duration: "1 hour" },
                { name: "Magic Lock", lore: "Petty Magic", castingNumber: 3, range: "Touch", target: "1", duration: "24 hours" },
                { name: "Fireball", lore: "Fire", castingNumber: 5, range: "24 yards", target: "1", duration: "Instant" },
                { name: "Flaming Sword of Rhuin", lore: "Fire", castingNumber: 7, range: "6 yards", target: "1", duration: "Willpower Bonus rounds" },
                { name: "Heal", lore: "Life", castingNumber: 4, range: "Touch", target: "1", duration: "Instant" },
                { name: "Blessing", lore: "Sigmar", castingNumber: 3, range: "6 yards", target: "Willpower Bonus", duration: "Willpower Bonus rounds" }
            ];
            console.log('Using fallback spells data:', srdSpells.length, 'spells loaded');
        });
}

        // Embedded SRD data as fallback (using your provided JSON)
        function loadEmbeddedSRDData() {
            // Embedded weapons data
            srdWeapons = [
                {"name":"Hand Weapon","category":"basic","damage":"SB+4","reach":"Average","encumbrance":1,"qualities":[],"flaws":[],"cost":"1GC"},
                {"name":"Dagger","category":"basic","damage":"SB+2","reach":"Very Short","encumbrance":0,"qualities":[],"flaws":[],"cost":"P16D"},
                {"name":"Sword","category":"basic","damage":"SB+4","reach":"Average","encumbrance":1,"qualities":[],"flaws":[],"cost":"1GC"},
                {"name":"Bow","category":"bow","damage":"SB+3","reach":50,"encumbrance":2,"qualities":[],"flaws":[],"cost":"4GC"},
                {"name":"Crossbow","category":"crossbow","damage":9,"reach":60,"encumbrance":2,"qualities":[],"flaws":["Reload 1"],"cost":"5GC"},
                {"name":"Pistol","category":"blackpowder","damage":8,"reach":20,"encumbrance":0,"qualities":["Blackpowder","Damaging","Pistol"],"flaws":["Reload 1"],"cost":"8GC"},
                {"name":"Shield","category":"basic","damage":"SB+2","reach":"Very Short","encumbrance":1,"qualities":["Shield 2","Defensive"],"flaws":["Undamaging"],"cost":"2GC"},
                {"name":"Spear","category":"polearm","damage":"SB+4","reach":"Very Long","encumbrance":2,"qualities":["Impale"],"flaws":[],"cost":"P15D"},
                {"name":"Halberd","category":"polearm","damage":"SB+4","reach":"Long","encumbrance":3,"qualities":["Defensive","Hack","Impale"],"flaws":[],"cost":"2GC"},
                {"name":"Rapier","category":"fencing","damage":"SB+4","reach":"Long","encumbrance":1,"qualities":["Fast","Impale"],"flaws":[],"cost":"5GC"}
            ];
            
            // Embedded armour data
            srdArmour = [
                {"name":"Leather Jerkin","category":"Soft Leather","ap":1,"locations":["Body"],"encumbrance":1,"cost":"P10D"},
                {"name":"Leather Jack","category":"Soft Leather","ap":1,"locations":["Arms","Body"],"encumbrance":1,"cost":"P12D"},
                {"name":"Leather Skullcap","category":"Soft Leather","ap":1,"locations":["Head"],"encumbrance":1,"cost":"P8D"},
                {"name":"Mail Shirt","category":"Mail","ap":2,"locations":["Body"],"encumbrance":2,"cost":"2GC"},
                {"name":"Mail Coat","category":"Mail","ap":2,"locations":["Arms","Body"],"encumbrance":3,"cost":"3GC"},
                {"name":"Breastplate (Plate)","category":"Plate","ap":2,"locations":["Body"],"encumbrance":3,"cost":"10GC"},
                {"name":"Helm","category":"Plate","ap":2,"locations":["Head"],"encumbrance":2,"cost":"3GC"},
                {"name":"Open Helm","category":"Plate","ap":2,"locations":["Head"],"encumbrance":1,"cost":"2GC"}
            ];
            
            // Standard ammunition types based on weapon categories
            srdAmmunition = [
                {"name":"Arrows","type":"bow","cost":"P1D","encumbrance":0.1,"notes":"Standard arrows for bows"},
                {"name":"Bolts","type":"crossbow","cost":"P2D","encumbrance":0.1,"notes":"Standard crossbow bolts"},
                {"name":"Lead Bullets","type":"sling","cost":"P1D","encumbrance":0.1,"notes":"Ammunition for slings"},
                {"name":"Powder & Shot","type":"blackpowder","cost":"P3D","encumbrance":0.1,"notes":"Single shot for blackpowder weapons"},
                {"name":"Throwing Knives","type":"throwing","cost":"P18D","encumbrance":0,"notes":"Can be recovered after battle"},
                {"name":"Darts","type":"throwing","cost":"P2D","encumbrance":0,"notes":"Light throwing weapons"},
                {"name":"Bandages","type":"medical","cost":"P3D","encumbrance":0,"notes":"Heals 1 Wound with successful Heal test"},
                {"name":"Healing Draught","type":"medical","cost":"3GC","encumbrance":0,"notes":"Heals 1d10 Wounds"},
                {"name":"Torches","type":"utility","cost":"P1D","encumbrance":0.5,"notes":"Provides light for 1 hour"},
                {"name":"Oil (lamp)","type":"utility","cost":"P2D","encumbrance":0.5,"notes":"Fuel for lanterns, 4 hours"},
                {"name":"Rations (1 day)","type":"provisions","cost":"P2D","encumbrance":0.5,"notes":"Food for one day"}
            ];
            
            console.log('Using embedded SRD data');
        }

        // Combat & Equipment Functions
        
        // Modal helper function
        window.closeModal = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // Weapons Management
        window.addWeapon = function() {
            // Create modal for weapon selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; max-width: 500px; max-height: 70vh; overflow-y: auto;';
            
            modalContent.innerHTML = `
                <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Weapon</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Select Weapon:</label>
                    <select id="weapon-select" style="width: 100%; padding: 5px;">
                        <option value="">Choose a weapon...</option>
                        <option value="custom">-- Custom Weapon --</option>
                        ${srdWeapons.map(w => `<option value="${w.name}">${w.name} (${w.category})</option>`).join('')}
                    </select>
                </div>
                <div id="weapon-details" style="display: none; margin-bottom: 15px; padding: 10px; background: #e8dfd0; border: 1px solid #8b7355;">
                    <p><strong>Category:</strong> <span id="detail-category"></span></p>
                    <p><strong>Damage:</strong> <span id="detail-damage"></span></p>
                    <p><strong>Reach/Range:</strong> <span id="detail-reach"></span></p>
                    <p><strong>Encumbrance:</strong> <span id="detail-enc"></span></p>
                    <p><strong>Qualities:</strong> <span id="detail-qualities"></span></p>
                    <p><strong>Flaws:</strong> <span id="detail-flaws"></span></p>
                    <p><strong>Cost:</strong> <span id="detail-cost"></span></p>
                </div>
                <div id="custom-weapon-fields" style="display: none;">
                    <input type="text" id="custom-name" placeholder="Weapon name" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-group" placeholder="Weapon group" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-enc" placeholder="Encumbrance" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-range" placeholder="Range/Reach" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-damage" placeholder="Damage" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-qualities" placeholder="Qualities" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                </div>
                <div style="text-align: center;">
                    <button onclick="window.confirmAddWeapon()" style="margin-right: 10px; padding: 8px 16px; background: #3e2f1f; color: #faf8f3; border: none; cursor: pointer;">Add Weapon</button>
                    <button onclick="window.closeModal()" style="padding: 8px 16px; background: #8b7355; color: #faf8f3; border: none; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Add event listener for weapon selection
            document.getElementById('weapon-select').addEventListener('change', function() {
                const selectedName = this.value;
                const detailsDiv = document.getElementById('weapon-details');
                const customFields = document.getElementById('custom-weapon-fields');
                
                if (selectedName === 'custom') {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'block';
                } else if (selectedName) {
                    const weapon = srdWeapons.find(w => w.name === selectedName);
                    if (weapon) {
                        document.getElementById('detail-category').textContent = weapon.category;
                        document.getElementById('detail-damage').textContent = weapon.damage;
                        document.getElementById('detail-reach').textContent = weapon.reach;
                        document.getElementById('detail-enc').textContent = weapon.encumbrance;
                        document.getElementById('detail-qualities').textContent = weapon.qualities.join(', ') || 'None';
                        document.getElementById('detail-flaws').textContent = weapon.flaws.join(', ') || 'None';
                        document.getElementById('detail-cost').textContent = weapon.cost;
                        detailsDiv.style.display = 'block';
                        customFields.style.display = 'none';
                    }
                } else {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'none';
                }
            });
        }

        window.confirmAddWeapon = function() {
            const selectedName = document.getElementById('weapon-select').value;
            
            if (!selectedName) {
                alert('Please select a weapon');
                return;
            }
            
            let weapon;
            if (selectedName === 'custom') {
                weapon = {
                    name: document.getElementById('custom-name').value,
                    group: document.getElementById('custom-group').value,
                    encumbrance: parseInt(document.getElementById('custom-enc').value) || 0,
                    range: document.getElementById('custom-range').value,
                    damage: document.getElementById('custom-damage').value,
                    qualities: document.getElementById('custom-qualities').value,
                    equipped: false
                };
                
                if (!weapon.name) {
                    alert('Please enter a weapon name');
                    return;
                }
            } else {
                const srdWeapon = srdWeapons.find(w => w.name === selectedName);
                weapon = {
                    name: srdWeapon.name,
                    group: srdWeapon.category,
                    encumbrance: srdWeapon.encumbrance,
                    range: srdWeapon.reach,
                    damage: srdWeapon.damage,
                    qualities: [...(srdWeapon.qualities || []), ...(srdWeapon.flaws || [])].join(', '),
                    equipped: false
                };
            }
            
            weapons.push(weapon);
            displayWeapons();
            updateEncumbrance();
            
            // Close modal
            window.closeModal();
        }

        window.displayWeapons = function() {
            const tbody = document.getElementById('weapons-tbody');
            tbody.innerHTML = '';
            
            weapons.forEach((weapon, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="skill-name-cell">${weapon.name}</td>
                    <td>${weapon.group}</td>
                    <td>${weapon.encumbrance}</td>
                    <td>${weapon.range}</td>
                    <td>${weapon.damage}</td>
                    <td style="font-size: 11px;">${weapon.qualities}</td>
                    <td><input type="checkbox" ${weapon.equipped ? 'checked' : ''} onchange="window.toggleWeaponEquipped(${index})"></td>
                    <td><button class="advance-btn" onclick="window.removeWeapon(${index})" style="background: #d44; color: white;">×</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        window.toggleWeaponEquipped = function(index) {
            weapons[index].equipped = !weapons[index].equipped;
        }

        window.removeWeapon = function(index) {
            if (confirm('Remove this weapon?')) {
                weapons.splice(index, 1);
                displayWeapons();
                updateEncumbrance();
            }
        }

        // Armour Management
        window.addArmour = function() {
            // Create modal for armour selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; max-width: 500px; max-height: 70vh; overflow-y: auto;';
            
            modalContent.innerHTML = `
                <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Armour</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Select Armour:</label>
                    <select id="armour-select" style="width: 100%; padding: 5px;">
                        <option value="">Choose armour...</option>
                        <option value="custom">-- Custom Armour --</option>
                        ${srdArmour.map(a => `<option value="${a.name}">${a.name} (${a.category})</option>`).join('')}
                    </select>
                </div>
                <div id="armour-details" style="display: none; margin-bottom: 15px; padding: 10px; background: #e8dfd0; border: 1px solid #8b7355;">
                    <p><strong>Category:</strong> <span id="detail-category"></span></p>
                    <p><strong>Armour Points:</strong> <span id="detail-ap"></span></p>
                    <p><strong>Locations:</strong> <span id="detail-locations"></span></p>
                    <p><strong>Encumbrance:</strong> <span id="detail-enc"></span></p>
                    <p><strong>Cost:</strong> <span id="detail-cost"></span></p>
                </div>
                <div id="custom-armour-fields" style="display: none;">
                    <input type="text" id="custom-name" placeholder="Armour name" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-type" placeholder="Type (e.g., Leather, Mail, Plate)" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-enc" placeholder="Encumbrance" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-head" placeholder="Head AP (0 if none)" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-arms" placeholder="Arms AP (0 if none)" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-body" placeholder="Body AP (0 if none)" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="number" id="custom-legs" placeholder="Legs AP (0 if none)" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <input type="text" id="custom-qualities" placeholder="Qualities/Notes" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                </div>
                <div style="text-align: center;">
                    <button onclick="window.confirmAddArmour()" style="margin-right: 10px; padding: 8px 16px; background: #3e2f1f; color: #faf8f3; border: none; cursor: pointer;">Add Armour</button>
                    <button onclick="window.closeModal()" style="padding: 8px 16px; background: #8b7355; color: #faf8f3; border: none; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Add event listener for armour selection
            document.getElementById('armour-select').addEventListener('change', function() {
                const selectedName = this.value;
                const detailsDiv = document.getElementById('armour-details');
                const customFields = document.getElementById('custom-armour-fields');
                
                if (selectedName === 'custom') {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'block';
                } else if (selectedName) {
                    const armourPiece = srdArmour.find(a => a.name === selectedName);
                    if (armourPiece) {
                        document.getElementById('detail-category').textContent = armourPiece.category;
                        document.getElementById('detail-ap').textContent = armourPiece.ap;
                        document.getElementById('detail-locations').textContent = armourPiece.locations.join(', ');
                        document.getElementById('detail-enc').textContent = armourPiece.encumbrance;
                        document.getElementById('detail-cost').textContent = armourPiece.cost;
                        detailsDiv.style.display = 'block';
                        customFields.style.display = 'none';
                    }
                } else {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'none';
                }
            });
        }

        window.confirmAddArmour = function() {
            const selectedName = document.getElementById('armour-select').value;
            
            if (!selectedName) {
                alert('Please select armour');
                return;
            }
            
            let armourPiece;
            if (selectedName === 'custom') {
                armourPiece = {
                    name: document.getElementById('custom-name').value,
                    type: document.getElementById('custom-type').value,
                    encumbrance: parseInt(document.getElementById('custom-enc').value) || 0,
                    head: parseInt(document.getElementById('custom-head').value) || 0,
                    arms: parseInt(document.getElementById('custom-arms').value) || 0,
                    body: parseInt(document.getElementById('custom-body').value) || 0,
                    legs: parseInt(document.getElementById('custom-legs').value) || 0,
                    qualities: document.getElementById('custom-qualities').value || '',
                    worn: false
                };
                
                if (!armourPiece.name) {
                    alert('Please enter an armour name');
                    return;
                }
            } else {
                const srdArmourPiece = srdArmour.find(a => a.name === selectedName);
                armourPiece = {
                    name: srdArmourPiece.name,
                    type: srdArmourPiece.category,
                    encumbrance: srdArmourPiece.encumbrance,
                    head: srdArmourPiece.locations.includes('Head') ? srdArmourPiece.ap : 0,
                    arms: srdArmourPiece.locations.includes('Arms') ? srdArmourPiece.ap : 0,
                    body: srdArmourPiece.locations.includes('Body') ? srdArmourPiece.ap : 0,
                    legs: srdArmourPiece.locations.includes('Legs') ? srdArmourPiece.ap : 0,
                    qualities: '',
                    worn: false
                };
            }
            
            armour.push(armourPiece);
            displayArmour();
            updateEncumbrance();
            updateTotalAP();
            
            // Close modal
            window.closeModal();
        }

        window.displayArmour = function() {
            const tbody = document.getElementById('armour-tbody');
            tbody.innerHTML = '';
            
            armour.forEach((piece, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="skill-name-cell">${piece.name}</td>
                    <td>${piece.type}</td>
                    <td>${piece.encumbrance}</td>
                    <td>${piece.head || '-'}</td>
                    <td>${piece.arms || '-'}</td>
                    <td>${piece.body || '-'}</td>
                    <td>${piece.legs || '-'}</td>
                    <td style="font-size: 11px;">${piece.qualities}</td>
                    <td><input type="checkbox" ${piece.worn ? 'checked' : ''} onchange="window.toggleArmourWorn(${index})"></td>
                    <td><button class="advance-btn" onclick="window.removeArmour(${index})" style="background: #d44; color: white;">×</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        window.toggleArmourWorn = function(index) {
            armour[index].worn = !armour[index].worn;
            updateTotalAP();
            updateEncumbrance();
        }

        window.removeArmour = function(index) {
            if (confirm('Remove this armour?')) {
                armour.splice(index, 1);
                displayArmour();
                updateEncumbrance();
                updateTotalAP();
            }
        }

        window.updateTotalAP = function() {
            let totalHead = 0, totalArms = 0, totalBody = 0, totalLegs = 0;
            
            armour.forEach(piece => {
                if (piece.worn) {
                    totalHead += piece.head || 0;
                    totalArms += piece.arms || 0;
                    totalBody += piece.body || 0;
                    totalLegs += piece.legs || 0;
                }
            });
            
            document.getElementById('total-ap-head').value = totalHead;
            document.getElementById('total-ap-arms').value = totalArms;
            document.getElementById('total-ap-body').value = totalBody;
            document.getElementById('total-ap-legs').value = totalLegs;
        }

        // Trappings/Inventory Management
        window.addTrapping = function() {
            const item = {
                name: prompt('Item name:'),
                quantity: parseInt(prompt('Quantity:') || '1'),
                encumbrance: parseFloat(prompt('Encumbrance per item:') || '0'),
                location: prompt('Carried where? (e.g., Backpack, Belt, Worn):') || 'Backpack',
                notes: prompt('Notes:') || ''
            };
            
            if (item.name) {
                trappings.push(item);
                displayTrappings();
                updateEncumbrance();
            }
        }

        window.displayTrappings = function() {
            const tbody = document.getElementById('trappings-tbody');
            tbody.innerHTML = '';
            
            trappings.forEach((item, index) => {
                const totalEnc = (item.quantity * item.encumbrance).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="skill-name-cell">${item.name}</td>
                    <td><input type="number" value="${item.quantity}" min="0" onchange="window.updateTrappingQuantity(${index}, this.value)" style="width: 60px;"></td>
                    <td>${item.encumbrance}</td>
                    <td style="font-weight: bold;">${totalEnc}</td>
                    <td>${item.location}</td>
                    <td><input type="text" value="${item.notes}" onchange="window.updateTrappingNotes(${index}, this.value)" style="width: 100%; border: none; font-size: 11px;"></td>
                    <td><button class="advance-btn" onclick="window.removeTrapping(${index})" style="background: #d44; color: white;">×</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        window.updateTrappingQuantity = function(index, value) {
            trappings[index].quantity = parseInt(value) || 0;
            displayTrappings();
            updateEncumbrance();
        }

        window.updateTrappingNotes = function(index, value) {
            trappings[index].notes = value;
        }

        window.removeTrapping = function(index) {
            if (confirm('Remove this item?')) {
                trappings.splice(index, 1);
                displayTrappings();
                updateEncumbrance();
            }
        }

        // Consumables Management
        window.addConsumable = function() {
            // Create modal for consumable selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #faf8f3; border: 3px solid #3e2f1f; padding: 20px; max-width: 500px; max-height: 70vh; overflow-y: auto;';
            
            // Check what ranged weapons the character has to suggest appropriate ammo
            const weaponCategories = [...new Set(weapons.map(w => w.group))];
            
            let suggestedAmmo = '';
            const suggestions = [];
            
            // Map weapon categories to ammunition subtypes
            if (weaponCategories.includes('bow')) {
                const bowAmmo = srdAmmunition.filter(a => a.subtype === 'bow');
                suggestions.push(...bowAmmo);
            }
            if (weaponCategories.includes('crossbow')) {
                const crossbowAmmo = srdAmmunition.filter(a => a.subtype === 'crossbow');
                suggestions.push(...crossbowAmmo);
            }
            if (weaponCategories.includes('blackpowder') || weaponCategories.includes('engineering')) {
                const blackpowderAmmo = srdAmmunition.filter(a => a.subtype === 'blackpowder');
                suggestions.push(...blackpowderAmmo);
            }
            if (weaponCategories.includes('sling')) {
                const slingAmmo = srdAmmunition.filter(a => a.subtype === 'sling');
                suggestions.push(...slingAmmo);
            }
            
            if (suggestions.length > 0) {
                suggestedAmmo = '<optgroup label="Suggested Ammunition (based on your weapons)">';
                suggestions.forEach(ammo => {
                    suggestedAmmo += `<option value="${ammo.name}">${ammo.name} (${ammo.quantity} for ${ammo.cost})</option>`;
                });
                suggestedAmmo += '</optgroup>';
            }
            
            // Group ammunition by subtype
            const ammoByType = {
                bow: srdAmmunition.filter(a => a.subtype === 'bow'),
                crossbow: srdAmmunition.filter(a => a.subtype === 'crossbow'),
                blackpowder: srdAmmunition.filter(a => a.subtype === 'blackpowder'),
                sling: srdAmmunition.filter(a => a.subtype === 'sling')
            };
            
            modalContent.innerHTML = `
                <h3 style="color: #3e2f1f; margin-bottom: 15px;">Add Ammunition/Consumable</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Select Item:</label>
                    <select id="consumable-select" style="width: 100%; padding: 5px;">
                        <option value="">Choose an item...</option>
                        ${suggestedAmmo}
                        ${ammoByType.bow.length > 0 ? `
                            <optgroup label="Bow Ammunition">
                                ${ammoByType.bow.map(a => `<option value="${a.name}">${a.name} (${a.quantity} for ${a.cost})</option>`).join('')}
                            </optgroup>
                        ` : ''}
                        ${ammoByType.crossbow.length > 0 ? `
                            <optgroup label="Crossbow Ammunition">
                                ${ammoByType.crossbow.map(a => `<option value="${a.name}">${a.name} (${a.quantity} for ${a.cost})</option>`).join('')}
                            </optgroup>
                        ` : ''}
                        ${ammoByType.blackpowder.length > 0 ? `
                            <optgroup label="Blackpowder Ammunition">
                                ${ammoByType.blackpowder.map(a => `<option value="${a.name}">${a.name} (${a.quantity} for ${a.cost})</option>`).join('')}
                            </optgroup>
                        ` : ''}
                        ${ammoByType.sling.length > 0 ? `
                            <optgroup label="Sling Ammunition">
                                ${ammoByType.sling.map(a => `<option value="${a.name}">${a.name} (${a.quantity} for ${a.cost})</option>`).join('')}
                            </optgroup>
                        ` : ''}
                        <optgroup label="Other">
                            <option value="Bandages">Bandages (Medical)</option>
                            <option value="Healing Draught">Healing Draught (Medical)</option>
                            <option value="Torches">Torches (Utility)</option>
                            <option value="Oil (lamp)">Oil for Lanterns (Utility)</option>
                            <option value="Rations">Rations (1 day)</option>
                        </optgroup>
                        <option value="custom">-- Custom Item --</option>
                    </select>
                </div>
                <div id="consumable-details" style="display: none; margin-bottom: 15px; padding: 10px; background: #e8dfd0; border: 1px solid #8b7355;">
                    <p><strong>Type:</strong> <span id="detail-type"></span></p>
                    <p><strong>Standard Quantity:</strong> <span id="detail-quantity"></span></p>
                    <p><strong>Cost:</strong> <span id="detail-cost"></span></p>
                    <p><strong>Availability:</strong> <span id="detail-availability"></span></p>
                    <p><strong>Qualities:</strong> <span id="detail-qualities"></span></p>
                    <p><strong>Range Modifier:</strong> <span id="detail-range"></span></p>
                    <p><strong>Damage Modifier:</strong> <span id="detail-damage"></span></p>
                    <p><strong>Notes:</strong> <span id="detail-notes"></span></p>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #3e2f1f;">Quantity to Add:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px;">Current:</label>
                            <input type="number" id="consumable-current" value="12" min="0" style="width: 100%; padding: 5px;">
                        </div>
                        <div>
                            <label style="font-size: 12px;">Maximum:</label>
                            <input type="number" id="consumable-max" value="24" min="0" style="width: 100%; padding: 5px;">
                        </div>
                    </div>
                </div>
                <div id="custom-consumable-fields" style="display: none;">
                    <input type="text" id="custom-name" placeholder="Item name" style="width: 100%; margin-bottom: 10px; padding: 5px;">
                    <textarea id="custom-notes" placeholder="Notes" style="width: 100%; margin-bottom: 10px; padding: 5px; height: 60px;"></textarea>
                </div>
                <div style="text-align: center;">
                    <button onclick="window.confirmAddConsumable()" style="margin-right: 10px; padding: 8px 16px; background: #3e2f1f; color: #faf8f3; border: none; cursor: pointer;">Add Item</button>
                    <button onclick="window.closeModal()" style="padding: 8px 16px; background: #8b7355; color: #faf8f3; border: none; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Set default quantities based on item type
            document.getElementById('consumable-select').addEventListener('change', function() {
                const selectedName = this.value;
                const detailsDiv = document.getElementById('consumable-details');
                const customFields = document.getElementById('custom-consumable-fields');
                const currentInput = document.getElementById('consumable-current');
                const maxInput = document.getElementById('consumable-max');
                
                if (selectedName === 'custom') {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'block';
                } else if (selectedName) {
                    const item = srdAmmunition.find(a => a.name === selectedName);
                    if (item) {
                        document.getElementById('detail-type').textContent = item.subtype || item.type;
                        document.getElementById('detail-quantity').textContent = item.quantity + ' per package';
                        document.getElementById('detail-cost').textContent = item.cost;
                        document.getElementById('detail-availability').textContent = item.availability || 'Common';
                        document.getElementById('detail-qualities').textContent = item.qualities?.join(', ') || 'None';
                        document.getElementById('detail-range').textContent = item.rangeModifier || 'N/A';
                        document.getElementById('detail-damage').textContent = item.damageModifier || 'N/A';
                        document.getElementById('detail-notes').textContent = item.notes || '';
                        detailsDiv.style.display = 'block';
                        customFields.style.display = 'none';
                        
                        // Set default quantities based on standard package
                        currentInput.value = item.quantity;
                        maxInput.value = item.quantity * 2;
                    } else {
                        // Handle non-ammunition items
                        detailsDiv.style.display = 'none';
                        customFields.style.display = 'none';
                        currentInput.value = 1;
                        maxInput.value = 5;
                    }
                } else {
                    detailsDiv.style.display = 'none';
                    customFields.style.display = 'none';
                }
            });
        }

        window.confirmAddConsumable = function() {
            const selectedName = document.getElementById('consumable-select').value;
            const current = parseInt(document.getElementById('consumable-current').value) || 0;
            const maximum = parseInt(document.getElementById('consumable-max').value) || 0;
            
            if (!selectedName) {
                alert('Please select an item');
                return;
            }
            
            let consumable;
            if (selectedName === 'custom') {
                consumable = {
                    name: document.getElementById('custom-name').value,
                    current: current,
                    maximum: maximum,
                    notes: document.getElementById('custom-notes').value || ''
                };
                
                if (!consumable.name) {
                    alert('Please enter an item name');
                    return;
                }
            } else {
                const item = srdAmmunition.find(a => a.name === selectedName);
                if (item) {
                    consumable = {
                        name: item.name,
                        current: current,
                        maximum: maximum,
                        notes: item.notes || ''
                    };
                } else {
                    // Handle non-ammunition items
                    consumable = {
                        name: selectedName,
                        current: current,
                        maximum: maximum,
                        notes: ''
                    };
                }
            }
            
            // Check if this consumable already exists and combine quantities
            const existing = consumables.find(c => c.name === consumable.name);
            if (existing) {
                existing.current += consumable.current;
                existing.maximum += consumable.maximum;
            } else {
                consumables.push(consumable);
            }
            
            displayConsumables();
            
            // Close modal
            window.closeModal();
        }

        window.displayConsumables = function() {
            const tbody = document.getElementById('consumables-tbody');
            tbody.innerHTML = '';
            
            consumables.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="skill-name-cell">${item.name}</td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button onclick="window.adjustConsumable(${index}, -1)" style="width: 25px; height: 22px; cursor: pointer;">-</button>
                            <input type="number" value="${item.current}" min="0" max="${item.maximum}" onchange="window.setConsumableCurrent(${index}, this.value)" style="width: 50px; text-align: center;">
                            <button onclick="window.adjustConsumable(${index}, 1)" style="width: 25px; height: 22px; cursor: pointer;">+</button>
                        </div>
                    </td>
                    <td><input type="number" value="${item.maximum}" min="0" onchange="window.setConsumableMax(${index}, this.value)" style="width: 60px;"></td>
                    <td><input type="text" value="${item.notes}" onchange="window.updateConsumableNotes(${index}, this.value)" style="width: 100%; border: none; font-size: 11px;"></td>
                    <td><button class="advance-btn" onclick="window.removeConsumable(${index})" style="background: #d44; color: white;">×</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        window.adjustConsumable = function(index, amount) {
            const newValue = consumables[index].current + amount;
            consumables[index].current = Math.max(0, Math.min(newValue, consumables[index].maximum));
            displayConsumables();
        }

        window.setConsumableCurrent = function(index, value) {
            consumables[index].current = Math.max(0, Math.min(parseInt(value) || 0, consumables[index].maximum));
            displayConsumables();
        }

        window.setConsumableMax = function(index, value) {
            consumables[index].maximum = parseInt(value) || 0;
            if (consumables[index].current > consumables[index].maximum) {
                consumables[index].current = consumables[index].maximum;
            }
            displayConsumables();
        }

        window.updateConsumableNotes = function(index, value) {
            consumables[index].notes = value;
        }

        window.removeConsumable = function(index) {
            if (confirm('Remove this consumable?')) {
                consumables.splice(index, 1);
                displayConsumables();
            }
        }

        // Encumbrance Calculation
        window.updateEncumbrance = function() {
            let weaponsEnc = 0;
            let armourEnc = 0;
            let trappingsEnc = 0;
            
            // Add weapon encumbrance (only equipped weapons count)
            weapons.forEach(weapon => {
                if (weapon.equipped) {
                    weaponsEnc += weapon.encumbrance || 0;
                }
            });
            
            // Add armour encumbrance (worn items get -1 encumbrance reduction)
            armour.forEach(piece => {
                if (piece.worn) {
                    // Worn items get their encumbrance reduced by 1 (minimum 0)
                    const wornEnc = Math.max(0, (piece.encumbrance || 0) - 1);
                    armourEnc += wornEnc;
                } else {
                    // Not worn, full encumbrance
                    armourEnc += piece.encumbrance || 0;
                }
            });
            
            // Add trapping encumbrance
            trappings.forEach(item => {
                trappingsEnc += (item.quantity * item.encumbrance) || 0;
            });
            
            // Add money weight (1 Enc per 200 coins)
            const gold = parseInt(document.getElementById('money-gold').value) || 0;
            const silver = parseInt(document.getElementById('money-silver').value) || 0;
            const brass = parseInt(document.getElementById('money-brass').value) || 0;
            const totalCoins = gold + silver + brass;
            const moneyEnc = Math.floor(totalCoins / 200);
            
            // Calculate total encumbrance
            const totalEnc = weaponsEnc + armourEnc + trappingsEnc + moneyEnc;
            
            // Calculate max encumbrance (Strength Bonus + Toughness Bonus)
            const strength = parseInt(document.getElementById('s-current').value) || 0;
            const toughness = parseInt(document.getElementById('t-current').value) || 0;
            const sb = Math.floor(strength / 10);
            const tb = Math.floor(toughness / 10);
            const maxEnc = sb + tb;
            
            // Update display
            document.getElementById('current-enc').value = totalEnc.toFixed(1);
            document.getElementById('max-enc').value = maxEnc;
            
            // Update breakdown display
            document.getElementById('enc-weapons').textContent = weaponsEnc.toFixed(1);
            document.getElementById('enc-armour').textContent = armourEnc.toFixed(1);
            document.getElementById('enc-trappings').textContent = trappingsEnc.toFixed(1);
            document.getElementById('enc-money').textContent = moneyEnc + (totalCoins > 0 ? ` (${totalCoins} coins)` : '');
            
            // Calculate penalties based on encumbrance level
            const statusField = document.getElementById('enc-status');
            const penaltiesField = document.getElementById('enc-penalties');
            const movementField = document.getElementById('movement');
            const baseMovement = parseInt(movementField.getAttribute('data-base-movement') || movementField.value || 4);
            
            // Store base movement if not already stored
            if (!movementField.getAttribute('data-base-movement')) {
                movementField.setAttribute('data-base-movement', movementField.value || 4);
            }
            
            let movementPenalty = 0;
            let agilityPenalty = 0;
            let travelFatigue = 0;
            let statusText = '';
            let statusColor = '';
            let penaltiesText = '';
            let penaltiesColor = '';
            
            if (totalEnc <= maxEnc) {
                // No penalties
                statusText = 'Unencumbered';
                statusColor = 'green';
                penaltiesText = 'None';
                penaltiesColor = 'green';
                movementPenalty = 0;
                agilityPenalty = 0;
                travelFatigue = 0;
            } else if (totalEnc <= maxEnc * 2) {
                // Up to double limit
                statusText = 'Encumbered';
                statusColor = 'orange';
                penaltiesText = '-1 Movement (min 3), -10 Agility, +1 Travel Fatigue';
                penaltiesColor = 'orange';
                movementPenalty = 1;
                agilityPenalty = 10;
                travelFatigue = 1;
            } else if (totalEnc <= maxEnc * 3) {
                // Up to triple limit
                statusText = 'Very Encumbered';
                statusColor = 'red';
                penaltiesText = '-2 Movement (min 2), -20 Agility (min 10), +2 Travel Fatigue';
                penaltiesColor = 'red';
                movementPenalty = 2;
                agilityPenalty = 20;
                travelFatigue = 2;
            } else {
                // More than 3x limit
                statusText = 'Immobilized!';
                statusColor = 'darkred';
                penaltiesText = 'Cannot move! Drop items immediately!';
                penaltiesColor = 'darkred';
                movementPenalty = 999; // Effectively immobilized
            }
            
            statusField.value = statusText;
            statusField.style.color = statusColor;
            penaltiesField.textContent = penaltiesText;
            penaltiesField.style.color = penaltiesColor;
            
            // Apply movement penalty (minimum based on encumbrance level)
            let newMovement = baseMovement - movementPenalty;
            if (totalEnc <= maxEnc * 2) {
                newMovement = Math.max(3, newMovement); // Minimum 3 for encumbered
            } else if (totalEnc <= maxEnc * 3) {
                newMovement = Math.max(2, newMovement); // Minimum 2 for very encumbered
            } else {
                newMovement = 0; // Cannot move when over 3x limit
            }
            
            // Update movement field with penalty applied
            if (movementPenalty > 0 && movementPenalty < 999) {
                movementField.value = newMovement;
                movementField.style.color = 'red';
                movementField.title = `Base Movement: ${baseMovement}, Encumbrance Penalty: -${movementPenalty}`;
            } else if (movementPenalty === 999) {
                movementField.value = 0;
                movementField.style.color = 'darkred';
                movementField.title = 'Too encumbered to move!';
            } else {
                movementField.value = baseMovement;
                movementField.style.color = '';
                movementField.title = '';
            }
            
            // Update walk and run based on new movement
            const walkField = document.getElementById('walk');
            const runField = document.getElementById('run');
            walkField.value = newMovement * 2;
            runField.value = newMovement * 4;
            
            // Store penalties for reference (could be displayed elsewhere)
            document.getElementById('enc-status').setAttribute('data-agility-penalty', agilityPenalty);
            document.getElementById('enc-status').setAttribute('data-travel-fatigue', travelFatigue);
            
            // Update Agility to show penalty
            const agCurrent = document.getElementById('ag-current');
            if (agCurrent && agCurrent.updateFunction) {
                agCurrent.updateFunction();
            }
        }
    </script>
</body>
</html>